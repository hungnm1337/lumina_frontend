@if (questions && questions.length > 0 && !finished) {
<div
  class="bg-white rounded-lg border border-gray-200 shadow-sm p-5 flex flex-col gap-3"
>
  <div class="flex items-start justify-between gap-3">
    <div class="space-y-2">
      <app-time
        [time]="questions[currentIndex].time"
        [resetAt]="currentIndex"
        [paused]="showExplain"
        (timeout)="onTimeout()"
      ></app-time>
    </div>
    <h3 class="text-lg font-semibold text-gray-800 flex-1">
      {{ questions[currentIndex].stemText }}
    </h3>
    <span class="text-xs text-gray-500 inline-flex items-center gap-2">
      <span class="bg-gray-100 px-2 py-1 rounded"
        >Type: {{ questions[currentIndex].questionType }}</span
      >
      <span class="bg-gray-100 px-2 py-1 rounded"
        >Score: {{ questions[currentIndex].scoreWeight }}</span
      >
      <span class="bg-green-100 text-green-700 px-2 py-1 rounded font-medium"
        >Your score: {{ totalScore }}</span
      >
    </span>
  </div>

  <div class="grid gap-4 mt-3">
    <div class="space-y-2">

      <app-prompt
        [prompt]="questions[currentIndex].prompt"
        [resetAt]="currentIndex"
        [questionType]="questions[currentIndex].questionType ?? ''"
        (pictureCaptionChange)="onPictureCaption($event)"
      ></app-prompt>
    </div>
  </div>

  <div class="mt-2">
    @if (questions[currentIndex].questionType === 'SINGLE_CHOICE') { @if
    (isListeningQuestion(questions[currentIndex].questionType ?? '')) {
    <app-listening
      [questions]="questions"
      [partInfo]="null"
      (listeningAnswered)="markAnswered($event)"
    ></app-listening>
    } @else {
    <app-reading
      [questions]="questions"
      [partInfo]="null"
      (readingAnswered)="markAnswered($event)"
    ></app-reading>
    } } @else if (questions[currentIndex].questionType === 'WRITTING') {
    <!-- Writing component here -->
    }

    <!-- Navigation for Non-Speaking Questions (Original) -->
    <div class="mt-4 flex items-center justify-between">
      <div class="text-sm text-gray-500">
        Question {{ currentIndex + 1 }} / {{ questions.length }}
      </div>
      @if (showExplain && !finished) {
      <button
        class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
        (click)="next()"
      >
        Next
      </button>
      } @else if (showExplain && finished) {
      <button
        class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700"
        (click)="goToExams()"
      >
        View results
      </button>
      }
    </div>
  </div>

  @if (showExplain) {
  <div
    class="mt-3 p-3 rounded-md bg-blue-50 border border-blue-200 text-blue-800 text-sm"
  >
    {{ questions[currentIndex].questionExplain }}
  </div>
  }
</div>
} @if (finished) {
<div class="mt-4 bg-white rounded-lg border border-gray-200 shadow-sm p-5">
  <div class="flex items-center justify-between">
    <div class="text-gray-800 font-semibold">Completed</div>
    <div class="text-sm text-gray-600">Score: {{ totalScore }}</div>
  </div>
  <div class="mt-3 text-gray-700">
    You answered correctly {{ correctCount }}/{{ questions.length }} ({{
      percentCorrect
    }}%).
  </div>
  <div
    class="mt-2 p-3 rounded-md"
    [ngClass]="{
      'bg-red-50 text-red-700 border border-red-200': percentCorrect < 30,
      'bg-yellow-50 text-yellow-700 border border-yellow-200':
        percentCorrect >= 30 && percentCorrect < 60,
      'bg-green-50 text-green-700 border border-green-200': percentCorrect >= 60
    }"
  >
    {{ feedbackText }}
  </div>
  <div class="mt-4">
    <div class="text-sm font-medium text-gray-700 mb-2">
      Saved answers (localStorage)
    </div>
    @if (savedAnswers && savedAnswers.length > 0) {
    <ul class="pl-0 text-sm text-gray-700 space-y-1">
      @for (ans of savedAnswers; track ans.questionId) {
      <li class="flex items-center gap-2">
        <span class="inline-block min-w-24">Question {{ ans.questionId }}</span>
        <span class="inline-block">â†’ Selected: {{ ans.optionId }}</span>
        <span
          class="inline-block ml-2"
          [ngClass]="{
            'bg-green-100 text-green-700 border border-green-200':
              isAnswerOptionCorrect(ans.questionId, ans.optionId) === true,
            'bg-red-100 text-red-700 border border-red-200':
              isAnswerOptionCorrect(ans.questionId, ans.optionId) === false,
            'bg-gray-100 text-gray-700 border border-gray-200':
              isAnswerOptionCorrect(ans.questionId, ans.optionId) === null
          }"
          class="px-2 py-0.5 rounded text-xs"
        >
          {{
            isAnswerOptionCorrect(ans.questionId, ans.optionId) === true
              ? "Correct"
              : isAnswerOptionCorrect(ans.questionId, ans.optionId) === false
              ? "Wrong"
              : "Undetermined"
          }}
        </span>
      </li>
      }
    </ul>
    } @else {
    <div class="text-sm text-gray-500">No saved data.</div>
    }
    <button
      class="mt-3 px-3 py-1.5 rounded bg-red-600 text-white hover:bg-red-700"
      (click)="clearSavedAnswers()"
    >
      Clear storage
    </button>
  </div>
  <div class="flex gap-4">
    <div class="mt-4">
      <button
        class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
        (click)="resetQuiz()"
      >
        Retry
      </button>
    </div>

    <div class="mt-4">
      <button
        class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700"
        (click)="goToExams()"
      >
        Other exams
      </button>
    </div>
  </div>
</div>
}
