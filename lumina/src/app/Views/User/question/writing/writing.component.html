@if (questions && questions.length > 0 && !isFinished) {
<div class="w-full bg-white rounded-lg shadow-md p-6">
  <!-- Progress Header -->
  <div class="mb-4 flex items-center justify-between">
    <div class="text-sm text-gray-600">
      Câu {{ currentIndex + 1 }} / {{ questions.length }}
    </div>
    <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded font-medium">
      Điểm: {{ totalScore }}
    </span>
  </div>

  @if (showExplain && isFetchingFeedback) {
  <!-- Global feedback fetching screen -->
  <div class="py-10 text-center">
    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 border border-blue-200 mb-3">
      <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25" />
        <path d="M4 12h16" stroke="currentColor" stroke-width="4" stroke-linecap="round" class="opacity-75" />
      </svg>
    </div>
    <div class="text-lg font-semibold text-gray-800">Đang tổng hợp phản hồi từ AI...</div>
    <div class="text-sm text-gray-600 mt-1">{{ feedbackDone }} / {{ feedbackTotal }} câu</div>
  </div>
  } @else {
  <!-- Header with Timer and Question Info -->
  <div class="flex items-start justify-between gap-3 mb-4">
    <div class="space-y-2">
      <app-time
        [time]="questions[currentIndex].time"
        [resetAt]="currentIndex"
        [paused]="showExplain"
        (timeout)="onTimeout()"
      ></app-time>
    </div>
  </div>
  }

  <!-- Question Content -->
  @if (getCurrentQuestion()) {
  <div class="border border-gray-200 rounded-lg p-4 mb-4">
    <div class="mb-3">
      <h4 class="font-medium text-gray-900 mb-2">
        Question {{ currentIndex + 1 }}: {{ getCurrentQuestion()?.stemText }}
      </h4>
      @if (getCurrentQuestion()?.prompt?.contentText) {
      <div class="font-medium text-gray-600 mb-2">
        <strong>{{ getCurrentQuestion()?.prompt?.title }}</strong>
        {{ getCurrentQuestion()?.prompt?.contentText }}
      </div>
      }
    </div>

    @if (getCurrentQuestion()?.prompt?.referenceImageUrl) {
    <div class="mb-4 mx-auto">
      <img
        [src]="getCurrentQuestion()?.prompt?.referenceImageUrl"
        [alt]="'Question ' + (currentIndex + 1) + ' image'"
        class="max-w-full w-8/12 mx-auto h-auto rounded-lg border border-gray-200"
      />
    </div>

    <div class="mb-4">
      <button
        class="btn border-s-blue-400 inline-flex items-center gap-2 px-4 py-2 rounded-md border border-blue-500 text-blue-600 hover:bg-blue-50 active:bg-blue-100 disabled:opacity-60 disabled:cursor-not-allowed shadow-sm"
        (click)="showHint()"
        [disabled]="isCurrentCaptionLoading()"
      >
        Show Hint
      </button>
      @if (isCurrentCaptionLoading()) {
      <svg
        class="animate-spin h-4 w-4 text-blue-600 inline-block ml-2"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
        <path
          d="M4 12h16"
          stroke="currentColor"
          stroke-width="4"
          stroke-linecap="round"
        />
      </svg>
      }
      @if (isShowHint && !isCurrentCaptionLoading()) {
        <span class="ml-2 text-sm text-gray-600" *ngIf="getCurrentCaption()">
          Caption: {{ getCurrentCaption() }}
        </span>
      }
    </div>
    }

    <!-- Writing Answer Box -->
    <app-writing-answer-box
      [questionId]="getCurrentQuestion()?.questionId || 0"
      [disabled]="showExplain"
      [resetAt]="currentIndex"
      [contentText]="getCurrentQuestion()?.prompt?.contentText"
      [pictureCaption]="getCurrentCaption()"
      (answered)="
        onAnswerSubmitted(getCurrentQuestion()?.questionId || 0, $event)
      "
      (answerChange)="onAnswerChange($event.questionId, $event.answer)"
      (submitStart)="onSubmitStart($event)"
      (submitEnd)="onSubmitEnd($event)"
    ></app-writing-answer-box>

    <!-- Navigation Controls -->
    <div class="mt-6 flex items-center justify-between">
      <button
        (click)="previousQuestion()"
        [disabled]="currentIndex === 0 || isAnyQuestionSubmitting()"
        class="px-4 py-2 rounded bg-gray-500 text-white hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <i class="fas fa-arrow-left mr-2"></i>Câu trước
      </button>

      <div class="flex gap-2">
        <button
          (click)="confirmExit()"
          [disabled]="isAnyQuestionSubmitting()"
          class="px-4 py-2 rounded bg-gray-500 text-white hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Lưu & Thoát
        </button>
        <button
          (click)="finishWritingExam()"
          [disabled]="isAnyQuestionSubmitting()"
          class="px-4 py-2 rounded bg-orange-600 text-white hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Nộp bài
        </button>
      </div>

      <button
        (click)="nextQuestion()"
        [disabled]="currentIndex === questions.length - 1 || isAnyQuestionSubmitting()"
        class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Câu sau<i class="fas fa-arrow-right ml-2"></i>
      </button>
    </div>

    <!-- Question Navigator -->
    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
      <h4 class="text-sm font-semibold text-gray-600 mb-3">Navigator</h4>
      <div class="grid grid-cols-10 gap-2">
        @for (question of questions; track question.questionId; let i = $index)
        {
        <button
          (click)="navigateToQuestion(i)"
          [disabled]="isAnyQuestionSubmitting()"
          [class]="
            isAnyQuestionSubmitting()
              ? 'w-10 h-10 rounded-lg opacity-50 cursor-not-allowed ' + (
                  i === currentIndex
                    ? 'bg-blue-600 text-white font-semibold'
                    : isQuestionSubmitting(question.questionId)
                    ? 'bg-yellow-500 text-white font-semibold animate-pulse'
                    : isQuestionSubmitted(question.questionId)
                    ? 'bg-purple-500 text-white font-semibold'
                    : hasAnswer(question.questionId)
                    ? 'bg-green-500 text-white'
                    : 'bg-gray-200 text-gray-700'
                )
              : i === currentIndex
              ? 'w-10 h-10 rounded-lg bg-blue-600 text-white font-semibold'
              : isQuestionSubmitting(question.questionId)
              ? 'w-10 h-10 rounded-lg bg-yellow-500 text-white font-semibold animate-pulse'
              : isQuestionSubmitted(question.questionId)
              ? 'w-10 h-10 rounded-lg bg-purple-500 text-white font-semibold'
              : hasAnswer(question.questionId)
              ? 'w-10 h-10 rounded-lg bg-green-500 text-white'
              : 'w-10 h-10 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300'
          "
        >
          {{ i + 1 }}
        </button>
        }
      </div>

      <!-- ✅ Legend - Chú thích màu sắc -->
      <div class="mt-4 flex items-center gap-4 text-xs text-gray-600">
        <div class="flex items-center gap-1">
          <div class="w-4 h-4 bg-gray-200 rounded"></div>
          <span>Chưa làm</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-4 h-4 bg-green-500 rounded"></div>
          <span>Đã làm</span>
        </div>

        <div class="flex items-center gap-1">
          <div class="w-4 h-4 bg-purple-500 rounded"></div>
          <span>Đã nộp</span>
        </div>
        <div class="flex items-center gap-1">
          <div class="w-4 h-4 bg-blue-600 rounded"></div>
          <span>Đang làm</span>
        </div>
      </div>
    </div>
  </div>
  } @if (showExplain) {
  <div
    class="mt-3 p-3 rounded-md bg-blue-50 border border-blue-200 text-blue-800 text-sm"
  >
    {{ getCurrentQuestion()?.questionExplain }}
  </div>
  }
</div>
} @if (isFinished) {
<!-- Summary Screen -->
<div class="text-center py-8 bg-white rounded-lg shadow-md p-6">
  <div
    class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full mb-4"
  >
    <i class="fas fa-trophy text-white text-4xl"></i>
  </div>
  <h2 class="text-3xl font-bold text-gray-800 mb-2">Hoàn thành bài Writing!</h2>
  <p class="text-gray-600 mb-6">Writing Practice</p>

  <!-- Score Statistics -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-6">
      <div class="text-4xl font-bold text-purple-600 mb-2">
        {{ totalScore }}
      </div>
      <div class="text-sm text-purple-700">Tổng điểm</div>
    </div>
    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6">
      <div class="text-4xl font-bold text-green-600 mb-2">
        {{ correctCount }}/{{ questions?.length || 0 }}
      </div>
      <div class="text-sm text-green-700">Số câu</div>
    </div>
    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-6">
      <div class="text-4xl font-bold text-blue-600 mb-2">
        {{ percentCorrect }}%
      </div>
      <div class="text-sm text-blue-700">Tỷ lệ hoàn thành</div>
    </div>
  </div>

  <p class="text-lg text-gray-700 mb-6">{{ feedbackText }}</p>

  <!-- Action Buttons -->
  <div class="flex gap-4 justify-center">
    <button
      (click)="viewHistory()"
      class="px-6 py-4 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white hover:from-blue-700 hover:to-indigo-700 font-semibold shadow-lg"
    >
      <i class="fas fa-history mr-2"></i>Xem lịch sử làm bài
    </button>
    <button
      (click)="resetExam()"
      class="px-6 py-4 rounded-xl bg-gradient-to-r from-green-600 to-teal-600 text-white hover:from-green-700 hover:to-teal-700 font-semibold shadow-lg"
    >
      <i class="fas fa-redo-alt mr-2"></i>Làm lại
    </button>
  </div>
</div>
}
