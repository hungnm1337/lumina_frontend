<app-popup
  *ngIf="showPopup"
  [title]="popupTitle"
  [message]="popupMessage"
  (okClicked)="onPopupOk()"
  (cancelClicked)="onPopupCancel()"
></app-popup>

<!-- Quota Limit Modal -->
<app-quota-limit-modal
  [isVisible]="showQuotaModal"
  [skill]="'writing'"
  [message]="quotaMessage"
  (close)="closeQuotaModal()"
></app-quota-limit-modal>

@if (questions && questions.length > 0 && !isFinished) {
<div class="w-full bg-white rounded-lg shadow-md p-6">
  <!-- Timer -->
  <div class="mb-4">
    <app-time
      [time]="questions[currentIndex].time"
      [resetAt]="currentIndex"
      [paused]="showExplain"
      (timeout)="onTimeout()"
    ></app-time>
  </div>

  <!-- Question Content -->
  @if (getCurrentQuestion()) {
  <div class="border border-gray-200 rounded-lg p-4 mb-4">
    <!-- Main Content: Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Left Column: Question Info + Image + Hint -->
      <div class="flex flex-col space-y-4">
        <div>
          <h4 class="font-medium text-gray-900 mb-2">
            Question {{ currentIndex + 1 }}:
            {{ getCurrentQuestion()?.stemText }}
          </h4>
          @if (getCurrentQuestion()?.prompt?.contentText) {
          <div class="font-medium text-gray-600 mb-2">
            <strong>{{ getCurrentQuestion()?.prompt?.title }}</strong>
            <p style="white-space: pre-wrap">
              {{ getCurrentQuestion()?.prompt?.contentText }}
            </p>
          </div>
          }
        </div>

        @if (getCurrentQuestion()?.prompt?.referenceImageUrl) {
        <div class="w-full">
          <img
            [src]="getCurrentQuestion()?.prompt?.referenceImageUrl"
            [alt]="'Question ' + (currentIndex + 1) + ' image'"
            class="w-full h-auto rounded-lg border border-gray-200"
          />
        </div>

        <div>
          <button
            class="btn border-s-blue-400 inline-flex items-center gap-2 px-4 py-2 rounded-md border border-blue-500 text-blue-600 hover:bg-blue-50 active:bg-blue-100 disabled:opacity-60 disabled:cursor-not-allowed shadow-sm"
            (click)="showHint()"
            [disabled]="isCurrentCaptionLoading()"
          >
            Show Hint
          </button>
          @if (isCurrentCaptionLoading()) {
          <svg
            class="animate-spin h-4 w-4 text-blue-600 inline-block ml-2"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            />
            <path
              d="M4 12h16"
              stroke="currentColor"
              stroke-width="4"
              stroke-linecap="round"
            />
          </svg>
          } @if (isShowHint && !isCurrentCaptionLoading()) {
          <span class="ml-2 text-sm text-gray-600" *ngIf="getCurrentCaption()">
            Caption: {{ getCurrentCaption() }}
          </span>
          }
        </div>
        }
      </div>

      <!-- Right Column: Writing Answer Box -->
      <div class="flex items-start">
        <div class="w-full">
          <app-writing-answer-box
            [questionId]="getCurrentQuestion()?.questionId || 0"
            [disabled]="showExplain"
            [resetAt]="currentIndex"
            [contentText]="getCurrentQuestion()?.prompt?.contentText"
            [pictureCaption]="getCurrentCaption()"
            (answered)="
              onAnswerSubmitted(getCurrentQuestion()?.questionId || 0, $event)
            "
            (answerChange)="onAnswerChange($event.questionId, $event.answer)"
            (submitStart)="onSubmitStart($event)"
            (submitEnd)="onSubmitEnd($event)"
          ></app-writing-answer-box>
        </div>
      </div>
    </div>

    <!-- Navigation Controls -->
    <div class="mt-4 flex items-center justify-between">
      <button
        (click)="previousQuestion()"
        [disabled]="currentIndex === 0"
        class="px-3 py-1.5 rounded-md bg-gray-500 text-white hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium shadow-sm"
      >
        <i class="fas fa-arrow-left mr-1.5"></i>Câu trước
      </button>

      <div class="flex gap-2">
        <!-- Chỉ hiển thị nút Nộp bài khi KHÔNG trong mock test -->
        @if (!isInMockTest) {
        <button
          (click)="finishWritingExam()"
          class="px-3 py-1.5 rounded-md bg-orange-600 text-white hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium shadow-sm"
        >
          Nộp bài
        </button>
        }
      </div>

      <!-- Nút Câu sau/Hoàn thành Part -->
      @if (isInMockTest && currentIndex === questions.length - 1) {
      <!-- Nếu đang trong mock test và ở câu cuối -->
      <button
        (click)="finishWritingExam()"
        class="px-3 py-1.5 rounded-md bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium shadow-sm"
      >
        Hoàn thành Part<i class="fas fa-check ml-1.5"></i>
      </button>
      } @else {
      <!-- Nút Câu sau bình thường -->
      <button
        (click)="nextQuestion()"
        [disabled]="currentIndex === questions.length - 1"
        class="px-3 py-1.5 rounded-md bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium shadow-sm"
      >
        Câu sau<i class="fas fa-arrow-right ml-1.5"></i>
      </button>
      }
    </div>

    <!-- Question Navigator -->
    <div class="mt-4">
      <div class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200">
        <h4 class="text-xs font-semibold text-gray-600 mb-2">Navigator</h4>
        <div class="grid grid-cols-20 gap-1.5">
          @for (question of questions; track question.questionId; let i =
          $index) {
          <button
            (click)="navigateToQuestion(i)"
            [class]="
              hasQuestionFeedback(question.questionId)
                ? 'w-8 h-8 rounded-md bg-green-600 text-white font-semibold text-xs shadow-sm' +
                  (i === currentIndex ? ' ring-2 ring-blue-400' : '')
                : isQuestionSubmitting(question.questionId)
                ? 'w-8 h-8 rounded-md bg-yellow-500 text-white font-semibold animate-pulse text-xs shadow-sm' +
                  (i === currentIndex ? ' ring-2 ring-blue-400' : '')
                : isQuestionSubmitted(question.questionId)
                ? 'w-8 h-8 rounded-md bg-purple-500 text-white font-semibold text-xs shadow-sm' +
                  (i === currentIndex ? ' ring-2 ring-blue-400' : '')
                : hasAnswer(question.questionId)
                ? 'w-8 h-8 rounded-md bg-orange-500 text-white text-xs shadow-sm' +
                  (i === currentIndex ? ' ring-2 ring-blue-400' : '')
                : i === currentIndex
                ? 'w-8 h-8 rounded-md bg-blue-600 text-white font-semibold text-xs shadow-sm'
                : 'w-8 h-8 rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300 text-xs'
            "
          >
            {{ i + 1 }}
          </button>
          }
        </div>

        <div class="mt-2.5 flex items-center gap-3 text-xs text-gray-600">
          <div class="flex items-center gap-1">
            <div class="w-3 h-3 bg-gray-200 rounded"></div>
            <span>Chưa làm</span>
          </div>
          <div class="flex items-center gap-1">
            <div class="w-3 h-3 bg-orange-500 rounded"></div>
            <span>Đã làm</span>
          </div>
          <div class="flex items-center gap-1">
            <div class="w-3 h-3 bg-purple-500 rounded"></div>
            <span>Đã nộp</span>
          </div>
          <div class="flex items-center gap-1">
            <div class="w-3 h-3 bg-yellow-500 rounded animate-pulse"></div>
            <span>Đang chấm</span>
          </div>
          <div class="flex items-center gap-1">
            <div class="w-3 h-3 bg-green-600 rounded"></div>
            <span>Đã chấm xong</span>
          </div>
          <div class="flex items-center gap-1">
            <div class="w-3 h-3 bg-blue-600 rounded"></div>
            <span>Đang làm</span>
          </div>
        </div>
      </div>
    </div>
    @if (showExplain) {
    <div
      class="mt-3 p-3 rounded-md bg-blue-50 border border-blue-200 text-blue-800 text-sm"
    >
      {{ getCurrentQuestion()?.questionExplain }}
    </div>
    }
  </div>
  }
</div>
} @if (isFinished) {
<!-- Summary Screen -->
<div class="text-center py-8 bg-white rounded-lg shadow-md p-6">
  <div
    class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full mb-4"
  >
    <i class="fas fa-trophy text-white text-4xl"></i>
  </div>
  <h2 class="text-3xl font-bold text-gray-800 mb-2">Hoàn thành bài Writing!</h2>
  <p class="text-gray-600 mb-6">Writing Practice</p>

  <!-- Score Statistics -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6">
      <div class="text-4xl font-bold text-green-600 mb-2">
        {{ correctCount }}/{{ questions?.length || 0 }}
      </div>
      <div class="text-sm text-green-700">Số câu</div>
    </div>
    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-6">
      <div class="text-4xl font-bold text-blue-600 mb-2">
        {{ percentCorrect }}%
      </div>
      <div class="text-sm text-blue-700">Tỷ lệ hoàn thành</div>
    </div>
  </div>

  <p class="text-lg text-gray-700 mb-6">{{ feedbackText }}</p>

  <!-- Action Buttons -->
  <div class="flex gap-4 justify-center">
    <button
      (click)="viewHistory()"
      class="px-6 py-4 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 text-white hover:from-blue-700 hover:to-indigo-700 font-semibold shadow-lg"
    >
      <i class="fas fa-history mr-2"></i>Xem lịch sử làm bài
    </button>
    <button
      (click)="showReportPopup = true"
      class="px-6 py-4 rounded-xl bg-gradient-to-r from-red-500 to-pink-500 text-white hover:from-red-600 hover:to-pink-600 font-semibold shadow-lg"
    >
      <i class="fas fa-flag mr-2"></i>Báo cáo bài thi
    </button>
    @if (showReportPopup) {
    <app-report-popup
      [type]="'Exam - ' + examId"
      (close)="onReportPopupClose()"
    ></app-report-popup>
    }
  </div>
</div>
}
