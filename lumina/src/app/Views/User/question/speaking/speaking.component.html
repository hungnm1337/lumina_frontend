<!-- Quota Limit Modal -->
<app-quota-limit-modal
  [isVisible]="showQuotaModal"
  [skill]="'speaking'"
  [message]="quotaMessage"
  (close)="closeQuotaModal()"
></app-quota-limit-modal>

@if (questions && questions.length > 0 && !finished) {
<div class="w-full bg-white rounded-lg shadow-md p-6">
  <!-- Progress Header -->
  <!-- <div class="mb-4 flex items-center justify-between">
    <div class="text-sm text-gray-600">
      C√¢u {{ currentIndex + 1 }} / {{ questions.length }}
    </div>
    <span class="bg-orange-100 text-orange-700 px-3 py-1 rounded font-medium">
      ƒêi·ªÉm: {{ totalScore }}
    </span>
  </div> -->

  <!-- Header with Timer -->
  <div class="flex items-start justify-between gap-3 mb-4">
    <div class="space-y-2">
      <app-time
        [time]="questions[currentIndex].time"
        [resetAt]="currentIndex"
        [paused]="showExplain"
        (timeout)="onTimeout()"
      ></app-time>
    </div>
    <h3 class="text-lg font-semibold text-gray-800 flex-1">
      {{ questions[currentIndex].stemText }}
    </h3>
  </div>

  <div class="grid gap-4 mt-3">
    <div class="space-y-2">
      <app-prompt
        [prompt]="questions[currentIndex].prompt"
        [resetAt]="currentIndex"
        [questionType]="questions[currentIndex].questionType ?? ''"
        (pictureCaptionChange)="onPictureCaption($event)"
      ></app-prompt>
    </div>
  </div>

  <div class="mt-2">
    @if (isSpeakingQuestion()) {
    <!-- Part 4 Information Panel (shown for all Part 4 questions) -->
    @if (getCurrentQuestionTiming().partNumber === 4) {
      <div class="mb-4 p-4 bg-yellow-50 border-2 border-yellow-400 rounded-lg">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-bold text-gray-800">
            <i class="fas fa-info-circle mr-2"></i>
            Th√¥ng tin tham kh·∫£o (Part 4)
          </h4>
        </div>
        
        <div class="prose max-w-none text-sm" [innerHTML]="questions[currentIndex].prompt">
        </div>
      </div>
    }
    
    <!-- ‚úÖ FIX Bug #18: Force component recreation on questionId change -->
    <!-- Using @for with single item to leverage trackBy and force Angular to destroy/recreate component -->
    @for (question of [questions[currentIndex]]; track question.questionId) {
    <app-speaking-answer-box
      [questionId]="question.questionId"
      [disabled]="showExplain || isAutoAdvancing"
      [resetAt]="resetCounter"
      [questionTime]="question.time"
      [preparationTime]="getCurrentQuestionTiming().preparationTime"
      [recordingTime]="getCurrentQuestionTiming().recordingTime"
      [showInfoPhase]="getCurrentQuestionTiming().showInfoPhase || false"
      [infoReadTime]="getCurrentQuestionTiming().infoReadTime || 0"
      [attemptId]="attemptId ?? 0"
      (answered)="onSpeakingAnswered($event)"
      (scoringResult)="onSpeakingResult($event)"
      (submitting)="onSpeakingSubmitting($event)"
      (recordingStatusChange)="onRecordingStatusChange($event)"
      (autoAdvanceNext)="onAutoAdvanceNext()"
    ></app-speaking-answer-box>
    }
    }

    <!-- Navigation for Speaking Questions -->
    <div class="mt-6">
      <!-- Auto-Advance Indicator -->
      @if (isAutoAdvancing) {
        <div class="fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-2xl z-50 animate-pulse">
          <i class="fas fa-spinner fa-spin mr-2"></i>
          ƒêang chuy·ªÉn c√¢u ti·∫øp theo...
        </div>
      }
      
      <!-- Navigation Controls - Auto Mode Only -->
      <div class="flex items-center justify-center mb-4">
        <!-- Ch·ªâ hi·ªÉn th·ªã n√∫t N·ªôp b√†i khi KH√îNG trong mock test -->
        @if (!isInMockTest) {
        <button
          (click)="finishSpeakingExam()"
          [disabled]="isAutoAdvancing"
          class="px-6 py-3 rounded-lg bg-orange-600 text-white hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed font-semibold shadow-lg"
        >
          <i class="fas fa-paper-plane mr-2"></i>
          N·ªôp b√†i
        </button>
        } @else if (isInMockTest && currentIndex === questions.length - 1) {
        <!-- Mock test: ch·ªâ hi·ªÉn th·ªã n√∫t Ho√†n th√†nh Part ·ªü c√¢u cu·ªëi -->
        <button
          (click)="finishSpeakingExam()"
          [disabled]="isAutoAdvancing"
          class="px-6 py-3 rounded-lg bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed font-semibold shadow-lg"
        >
          Ho√†n th√†nh Part<i class="fas fa-check ml-2"></i>
        </button>
        }
        
        <!-- INFO: T·ª± ƒë·ªông chuy·ªÉn c√¢u -->
        <div class="ml-4 text-sm text-gray-600 bg-blue-50 px-4 py-2 rounded-lg border border-blue-200">
          <i class="fas fa-info-circle mr-1 text-blue-600"></i>
          T·ª± ƒë·ªông chuy·ªÉn sang c√¢u ti·∫øp theo sau khi ghi √¢m xong
        </div>
      </div>

      <!-- ============================================ -->
      <!-- NAVIGATOR - DISABLED (Not in real TOEIC test) -->
      <!-- ============================================ -->
      <!--
      <div class="p-4 bg-gray-50 rounded-lg">
        <h4 class="text-sm font-semibold text-gray-600 mb-3">Navigator</h4>
        <div class="grid grid-cols-10 gap-2">
          @for (question of questions; track question.questionId; let i = $index) {
          <button
            (click)="navigateToQuestion(i)"
            [disabled]="isAutoAdvancing"
            [class]="
              getQuestionState(question.questionId) === 'scored'
                ? 'w-10 h-10 rounded-lg bg-green-600 text-white font-semibold' +
                  (i === currentIndex ? ' ring-4 ring-blue-400' : '')
                : getQuestionState(question.questionId) === 'scoring' ||
                  getQuestionState(question.questionId) === 'submitted'
                ? 'w-10 h-10 rounded-lg bg-yellow-500 text-white font-semibold animate-pulse' +
                  (i === currentIndex ? ' ring-4 ring-blue-400' : '')
                : getQuestionState(question.questionId) === 'has_recording'
                ? 'w-10 h-10 rounded-lg bg-purple-500 text-white' +
                  (i === currentIndex ? ' ring-4 ring-blue-400' : '')
                : i === currentIndex
                ? 'w-10 h-10 rounded-lg bg-blue-600 text-white font-semibold'
                : 'w-10 h-10 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed'
            "
            [title]="getQuestionStateText(question.questionId)"
          >
            {{ i + 1 }}
          </button>
          }
        </div>

        <div class="mt-4 flex items-center gap-4 text-xs text-gray-600">
          <div class="flex items-center gap-1">
            <div class="w-4 h-4 bg-gray-200 rounded"></div>
            <span>Ch∆∞a l√†m</span>
          </div>
          <div class="flex items-center gap-1">
            <div class="w-4 h-4 bg-purple-500 rounded"></div>
            <span>ƒê√£ ghi √¢m</span>
          </div>
          <div class="flex items-center gap-1">
            <div class="w-4 h-4 bg-yellow-500 rounded animate-pulse"></div>
            <span>ƒêang ch·∫•m</span>
          </div>
          <div class="flex items-center gap-1">
            <div class="w-4 h-4 bg-green-600 rounded"></div>
            <span>ƒê√£ ch·∫•m xong</span>
          </div>
          <div class="flex items-center gap-1">
            <div class="w-4 h-4 bg-blue-600 rounded"></div>
            <span>ƒêang l√†m</span>
          </div>
        </div>
      </div>
      -->
    </div>
  </div>

  @if (showExplain) {
  <div
    class="mt-3 p-3 rounded-md bg-blue-50 border border-blue-200 text-blue-800 text-sm"
  >
    {{ questions[currentIndex].questionExplain }}
  </div>
  }
</div>
} @if (finished) {
<!-- Summary Screen -->
<div class="text-center py-8 bg-white rounded-lg shadow-md p-6">
  <div
    class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full mb-4"
  >
    <i class="fas fa-trophy text-white text-4xl"></i>
  </div>
  <h2 class="text-3xl font-bold text-gray-800 mb-2">
    Ho√†n th√†nh b√†i Speaking!
  </h2>
  <p class="text-gray-600 mb-6">Speaking Practice</p>

  <!-- Score Statistics -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-6">
      <div class="text-4xl font-bold text-purple-600 mb-2">
        {{ totalScore }}
      </div>
      <div class="text-sm text-purple-700">T·ªïng ƒëi·ªÉm</div>
    </div>
    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6">
      <div class="text-4xl font-bold text-green-600 mb-2">
        {{ correctCount }}/{{ questions.length }}
      </div>
      <div class="text-sm text-green-700">S·ªë c√¢u</div>
    </div>
    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-6">
      <div class="text-4xl font-bold text-blue-600 mb-2">
        {{ percentCorrect }}%
      </div>
      <div class="text-sm text-blue-700">T·ª∑ l·ªá ho√†n th√†nh</div>
    </div>
  </div>

  <p class="text-lg text-gray-700 mb-6">{{ feedbackText }}</p>

  <!-- Action Buttons -->
  <div class="flex gap-4 justify-center">
    <button
      (click)="goToExams()"
      class="px-6 py-4 rounded-xl bg-gradient-to-r from-blue-600 to-cyan-600 text-white hover:from-blue-700 hover:to-cyan-700 font-semibold shadow-lg"
    >
      <i class="fas fa-list mr-2"></i>Ch·ªçn b√†i kh√°c
    </button>
  </div>
</div>
}

<!-- Speaking Summary Modal (Full Screen Overlay) -->
@if (showSpeakingSummary) {
<div
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
>
  <div
    class="bg-white rounded-lg shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto"
  >
    <!-- Modal Header -->
    <div
      class="sticky top-0 bg-white border-b border-gray-200 p-4 flex justify-between items-center z-10"
    >
      <h2 class="text-2xl font-bold text-gray-800">
        üìä K·∫øt qu·∫£ TOEIC Speaking Test
      </h2>
      <button (click)="showReportPopup = true"
        class="px-6 py-4 rounded-xl bg-gradient-to-r from-red-500 to-pink-500 text-white hover:from-red-600 hover:to-pink-600 font-semibold shadow-lg"
      >
        <i class="fas fa-flag mr-2"></i>B√°o c√°o b√†i thi
      </button>
      <app-report-popup
        *ngIf="showReportPopup"
        [type]="'Exam - ' + examId"
        (close)="onReportPopupClose()"
      ></app-report-popup>
      <button
        (click)="closeSpeakingSummary()"
        class="text-gray-500 hover:text-gray-700 text-2xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors"
        aria-label="ƒê√≥ng"
      >
        √ó
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-6">
      <app-speaking-summary
        [results]="speakingQuestionResults"
        (tryOtherTest)="onTryOtherSpeakingTest()"
      ></app-speaking-summary>

      <!-- Action buttons are now inside SpeakingSummaryComponent -->
    </div>
  </div>
</div>
}
