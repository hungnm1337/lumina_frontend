<app-header></app-header>
<div class="wrap">
  <div class="header">
    <div>
      <h1 class="title">H·ªì s∆° c√° nh√¢n</h1>
    </div>
    <div class="toolbar">
      <button class="btn primary" (click)="save()" [disabled]="loading()">
        {{
          editing() ? (loading() ? "ƒêang l∆∞u..." : "L∆∞u thay ƒë·ªïi") : "Ch·ªânh s·ª≠a"
        }}
      </button>
    </div>
  </div>

  <div *ngIf="loading()" class="loading">ƒêang t·∫£i h·ªì s∆°...</div>

  <ng-container *ngIf="!loading() && profile() as p">
    <div class="grid">
      <!-- SIDEBAR -->
      <aside class="card" aria-label="T·ªïng quan ng∆∞·ªùi d√πng">
        <div class="avatar">
          <img
            [src]="
              p.avatarUrl || 'https://api.dicebear.com/7.x/thumbs/svg?seed=user'
            "
            alt="·∫¢nh ƒë·∫°i di·ªán"
            class="avatar-img"
          />
          <div>
            <strong>{{ p.fullName || "‚Äî" }}</strong>
            <div class="muted">{{ p.email || "‚Äî" }}</div>

            <!-- Premium Subscription Info -->

            <div class="kpi">
              <div class="pill" title="Vai tr√≤">
                <i class="fas fa-user-shield"></i>
                {{ p.roleName || "‚Äî" }}
              </div>
              <div class="pill" title="Tham gia" *ngIf="p.joinDate">
                <i class="fas fa-calendar-alt"></i>
                {{ p.joinDate }}
              </div>
            </div>
          </div>
        </div>
        <div style="margin-top: 12px">
          <input
            type="file"
            accept="image/*"
            (change)="onAvatarChange($event)"
            #avatarInput
            style="display: none"
          />
          <button class="btn" (click)="avatarInput.click()">
            Thay ƒë·ªïi ·∫£nh
          </button>
          <div
            *ngIf="
              subscriptionStatus?.hasActiveSubscription &&
              subscriptionStatus?.subscriptionType === 'PREMIUM'
            "
            style="
              margin-top: 12px;
              padding: 12px;
              background: #ffffff;
              border-radius: 12px;
              box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
              border: 1px solid #d7d7d7;
            "
          >
            <div
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 6px;
              "
            >
             
              <span style="color: rgb(0, 0, 0); font-weight: bold; font-size: 14px"
                >G√≥i Premium</span
              >
            </div>
            <div
              style="
                color: rgba(88, 88, 88, 0.95);
                font-size: 12px;
                line-height: 1.5;
              "
            >
              <div
                style="
                  display: flex;
                  align-items: center;
                  gap: 6px;
                  margin-bottom: 4px;
                "
              >
                <span
                  >ƒêƒÉng k√Ω:
                  {{
                    subscriptionStatus?.startDate | date : "dd/MM/yyyy"
                  }}</span
                >
              </div>
              <div style="display: flex; align-items: center; gap: 6px">
                <span
                  >H·∫øt h·∫°n:
                  {{ subscriptionStatus?.endDate | date : "dd/MM/yyyy" }}</span
                >
              </div>
            </div>
          </div>
          <div class="status" *ngIf="avatarStatus">{{ avatarStatus }}</div>
        </div>
      </aside>

      <!-- MAIN -->
      <main style="display: grid; gap: 16px">
        <section class="card">
          <h3>Th√¥ng tin c∆° b·∫£n</h3>
          <div class="row">
            <div>
              <label>H·ªç v√† t√™n</label>
              <input
                type="text"
                [(ngModel)]="form.fullName"
                name="fullName"
                placeholder="VD: Nguy·ªÖn VƒÉn A"
                [disabled]="!editing()"
              />
            </div>
            <div>
              <label>Email</label>
              <input type="email" [value]="p.email" disabled />
            </div>
            <div>
              <label>S·ªë ƒëi·ªán tho·∫°i</label>
              <input
                type="tel"
                [(ngModel)]="form.phone"
                name="phone"
                placeholder="VD: 09xxxxxxxx"
                [disabled]="!editing()"
              />
            </div>
            <div>
              <label>Gi·ªõi thi·ªáu</label>
              <textarea
                [(ngModel)]="form.bio"
                name="bio"
                rows="3"
                placeholder="Gi·ªõi thi·ªáu v·ªÅ b·∫£n th√¢n..."
                [disabled]="!editing()"
              ></textarea>
            </div>
          </div>
          <div class="section-actions" *ngIf="editing()">
            <button class="btn ghost" (click)="cancel()">H·ªßy</button>
            <button class="btn primary" (click)="save()" [disabled]="loading()">
              {{ loading() ? "ƒêang l∆∞u..." : "L∆∞u thay ƒë·ªïi" }}
            </button>
          </div>
        </section>

        <section class="card">
          <h3>ƒê·ªïi m·∫≠t kh·∫©u</h3>
          <div class="row">
            <div>
              <label>M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
              <input
                type="password"
                [(ngModel)]="passwordForm.currentPassword"
                name="currentPassword"
                placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i"
                autocomplete="current-password"
              />
            </div>
            <div></div>
            <div>
              <label>M·∫≠t kh·∫©u m·ªõi (t·ªëi thi·ªÉu 8 k√Ω t·ª±)</label>
              <input
                type="password"
                [(ngModel)]="passwordForm.newPassword"
                name="newPassword"
                placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi"
                autocomplete="new-password"
              />
            </div>
            <div>
              <label>Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi</label>
              <input
                type="password"
                [(ngModel)]="passwordForm.confirmPassword"
                name="confirmPassword"
                placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi"
                autocomplete="new-password"
              />
            </div>
          </div>
          <div class="section-actions">
            <button
              class="btn primary"
              (click)="changePassword()"
              [disabled]="passwordLoading()"
            >
              {{ passwordLoading() ? "ƒêang c·∫≠p nh·∫≠t..." : "C·∫≠p nh·∫≠t m·∫≠t kh·∫©u" }}
            </button>
          </div>
          <div
            class="status"
            [class.success]="passwordStatus === 'success'"
            [class.error]="passwordStatus === 'error'"
            *ngIf="passwordStatus"
          >
            {{ passwordMessage }}
          </div>
        </section>
      </main>
    </div>
  </ng-container>
</div>

<!-- Image Cropper Modal - Dark Theme -->
<div *ngIf="showCropperModal" class="fixed inset-0 z-50 bg-black">
  <!-- Header -->
  <div class="flex items-center justify-between px-4 py-3 bg-gray-900">
    <button
      (click)="closeCropperModal()"
      class="p-2 hover:bg-gray-800 rounded-full transition-colors"
      aria-label="Close"
    >
      <svg
        class="w-6 h-6 text-white"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M10 19l-7-7m0 0l7-7m-7 7h18"
        ></path>
      </svg>
    </button>
    <div class="text-center">
      <h2 class="text-lg font-medium text-white">C·∫Øt v√† ch·ªânh s·ª≠a ·∫£nh</h2>
      <p class="text-xs text-gray-400 mt-1">
        üëÜ Click v√† k√©o ·∫£nh ƒë·ªÉ di chuy·ªÉn | üîç D√πng n√∫t/scroll ƒë·ªÉ zoom
      </p>
    </div>
    <div class="w-10"></div>
  </div>

  <!-- Main Content -->
  <div class="flex flex-col h-[calc(100vh-60px)]">
    <!-- Image Cropper Area -->
    <div
      class="flex-1 flex items-center justify-center px-4 py-6 overflow-hidden"
    >
      <div
        class="relative cropper-container"
        (wheel)="onWheelZoom($event)"
        style="width: 400px; height: 400px"
      >
        <canvas
          #cropCanvas
          (mousedown)="onCanvasMouseDown($event)"
          (mousemove)="onCanvasMouseMove($event)"
          (mouseup)="onCanvasMouseUp()"
          (mouseleave)="onCanvasMouseUp()"
          (touchstart)="onCanvasTouchStart($event)"
          (touchmove)="onCanvasTouchMove($event)"
          (touchend)="onCanvasTouchEnd()"
          [style.cursor]="isDragging ? 'grabbing' : 'grab'"
          style="
            width: 100%;
            height: 100%;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
          "
        ></canvas>
      </div>
    </div>

    <!-- Controls -->
    <div class="px-4 pb-6 space-y-4">
      <!-- Zoom Controls -->
      <div class="flex items-center justify-center gap-4">
        <button
          (click)="zoomOut()"
          class="p-3 bg-gray-800 hover:bg-gray-700 rounded-full transition-colors"
          type="button"
        >
          <svg
            class="w-5 h-5 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M20 12H4"
            ></path>
          </svg>
        </button>
        <div class="flex-1 max-w-xs">
          <input
            type="range"
            min="50"
            max="300"
            [value]="scale * 100"
            (input)="onZoomSlider($event)"
            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider"
          />
        </div>
        <button
          (click)="zoomIn()"
          class="p-3 bg-gray-800 hover:bg-gray-700 rounded-full transition-colors"
          type="button"
        >
          <svg
            class="w-5 h-5 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v16m8-8H4"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Rotate Button -->
      <div class="flex justify-center gap-4">
        <button
          (click)="rotateImage()"
          class="flex flex-col items-center gap-1 px-6 py-3 hover:bg-gray-800 rounded-lg transition-colors"
          type="button"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            ></path>
          </svg>
          <span class="text-xs text-gray-300">Xoay</span>
        </button>
        <button
          (click)="resetPosition()"
          class="flex flex-col items-center gap-1 px-6 py-3 hover:bg-gray-800 rounded-lg transition-colors"
          type="button"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            ></path>
          </svg>
          <span class="text-xs text-gray-300">ƒê·∫∑t l·∫°i</span>
        </button>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-3">
        <button
          (click)="closeCropperModal()"
          [disabled]="uploadingAvatar"
          class="flex-1 py-3 px-6 bg-gray-800 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50"
        >
          H·ªßy
        </button>
        <button
          (click)="cropAndUpload()"
          [disabled]="uploadingAvatar || !sourceImage"
          class="flex-1 py-3 px-6 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-all disabled:opacity-50 flex items-center justify-center gap-2"
        >
          <svg
            *ngIf="uploadingAvatar"
            class="animate-spin h-5 w-5 text-white"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <span>{{ uploadingAvatar ? "ƒêang t·∫£i..." : "Ti·∫øp theo" }}</span>
        </button>
      </div>
    </div>
  </div>
</div>
