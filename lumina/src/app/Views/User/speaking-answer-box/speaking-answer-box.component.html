<div class="speaking-answer-container">
  <!-- Trạng thái: Idle hoặc Error - Sẵn sàng ghi âm -->
  @if (canStartRecording || (!hasRecording && !isRecording && !isProcessing &&
  !isSubmitted)) {
  <div class="text-center py-8">
    <div class="mb-4">
      <svg
        class="w-20 h-20 mx-auto text-gray-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
        ></path>
      </svg>
    </div>

    @if (isError && errorMessage) {
    <div
      class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md text-red-700 text-sm"
    >
      {{ errorMessage }}
    </div>
    }

    <button
      (click)="startRecording()"
      [disabled]="disabled"
      class="px-6 py-3 text-lg font-medium text-white bg-red-600 border border-transparent rounded-full hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl"
    >
      <i class="fas fa-microphone mr-2"></i>
      Bắt đầu ghi âm
    </button>

    <p class="mt-3 text-sm text-gray-500">
      Nhấn nút để bắt đầu ghi âm câu trả lời của bạn
    </p>
  </div>
  }

  <!-- Trạng thái: Recording - Đang ghi âm -->
  @if (isRecording) {
  <div class="text-center py-8">
    <div class="mb-4">
      <div class="inline-block relative">
        <svg
          class="w-20 h-20 text-red-600 animate-pulse"
          fill="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"
          ></path>
          <path
            d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"
          ></path>
        </svg>
        <span class="absolute -top-1 -right-1 flex h-4 w-4">
          <span
            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"
          ></span>
          <span
            class="relative inline-flex rounded-full h-4 w-4 bg-red-500"
          ></span>
        </span>
      </div>
    </div>

    <div class="mb-4">
      <div class="text-4xl font-mono font-bold text-red-600">
        {{ formattedTime }}
      </div>
      <p class="text-sm text-gray-500 mt-1">Đang ghi âm...</p>
    </div>

    <div class="flex justify-center gap-3">
      <button
        (click)="stopRecording()"
        class="px-6 py-3 text-lg font-medium text-white bg-gray-600 border border-transparent rounded-full hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-all"
      >
        <i class="fas fa-stop mr-2"></i>
        Dừng ghi âm
      </button>
    </div>

    <div
      class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-md text-blue-700 text-sm"
    >
      <i class="fas fa-info-circle mr-1"></i>
      Tối đa 2 phút. Tự động dừng khi hết thời gian.
    </div>
  </div>
  }

  <!-- Trạng thái: Có bản ghi nhưng chưa submit -->
  @if (hasRecording && !isProcessing && !isSubmitted) {
  <div class="py-6">
    <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-md">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class="fas fa-check-circle text-green-600 text-2xl"></i>
          <div>
            <p class="font-medium text-green-800">
              Bản ghi âm đã được lưu (bản nháp)
            </p>
            <p class="text-sm text-green-600">
              Thời lượng: {{ formattedTime }}
            </p>
            <p class="text-xs text-green-500 mt-1">
              Bạn có thể ghi lại hoặc nộp bài để chấm điểm
            </p>
          </div>
        </div>
      </div>

      <!-- Audio Player for Draft Recording -->
      <div class="mb-4 p-3 bg-white rounded-md border border-gray-200">
        <h5 class="text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-volume-up mr-1"></i>
          Nghe lại bản ghi âm:
        </h5>
        <audio controls class="w-full" [src]="getAudioUrl()">
          Trình duyệt của bạn không hỗ trợ phát audio.
        </audio>
      </div>
    </div>

    <div class="flex gap-3 justify-end">
      <button
        (click)="cancelRecording()"
        [disabled]="disabled"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <i class="fas fa-redo mr-2"></i>
        Ghi lại
      </button>

      <button
        (click)="submitRecording()"
        [disabled]="disabled"
        class="px-6 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <i class="fas fa-paper-plane mr-2"></i>
        Nộp bài
      </button>
    </div>
  </div>
  }

  <!-- Trạng thái: Processing - Đang chấm điểm -->
  @if (isProcessing) {
  <div class="text-center py-8">
    <div class="mb-4">
      <svg
        class="animate-spin h-16 w-16 mx-auto text-blue-600"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
    </div>

    <h3 class="text-lg font-semibold text-gray-800 mb-2">Đang chấm điểm...</h3>
    <p class="text-sm text-gray-600">Vui lòng đợi trong giây lát</p>

    <div
      class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md text-yellow-700 text-sm"
    >
      <i class="fas fa-hourglass-half mr-1"></i>
      Hệ thống đang phân tích phát âm, ngữ pháp và nội dung của bạn
    </div>
  </div>
  }

  <!-- Trạng thái: Submitted - Đã nộp bài (ẩn chi tiết cho đến khi kết thúc bài thi) -->
  @if (isSubmitted) {
  <div class="py-6">
    <div
      class="p-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-300 rounded-lg shadow-sm"
    >
      <div class="text-center">
        <div
          class="inline-flex items-center justify-center w-16 h-16 bg-green-500 rounded-full mb-3"
        >
          <svg
            class="w-10 h-10 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"
            ></path>
          </svg>
        </div>
        <h3 class="text-2xl font-bold text-gray-800">Đã nộp và chấm xong!</h3>
        <p class="text-sm text-gray-600 mt-2">
          Kết quả chi tiết sẽ được hiển thị ở phần tổng kết khi bạn nhấn "Nộp
          bài thi".
        </p>
      </div>
    </div>
  </div>
  }
</div>
