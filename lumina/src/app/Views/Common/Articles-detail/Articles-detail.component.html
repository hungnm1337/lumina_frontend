<app-header></app-header>

<!-- Back to Blog Link -->
<div class="back-to-blog">
  <button (click)="goBackToBlog()" class="back-btn">
    <i class="fas fa-arrow-left"></i>
    Back to articles
  </button>
</div>

<!-- Article Content -->
<div class="article-container" *ngIf="!isLoading && article">
  <div class="article-content">
    <!-- Article Metadata -->
    <div class="article-meta">
      <span [class]="'category-tag ' + getCategoryColor(article.categoryName)">{{ article.categoryName }}</span>
      <span class="publish-date">{{ formatDate(article.createdAt) }}</span>
      <span class="read-time">{{ getReadTime(article.summary) }}</span>
      <!-- Completion Indicator -->
      <span class="completion-indicator" *ngIf="articleProgress && articleProgress.status === 'completed'">
        <i class="fas fa-check-circle"></i>
        Completed
      </span>
      <span class="progress-indicator" *ngIf="articleProgress && articleProgress.status === 'in_progress'">
        <i class="fas fa-clock"></i>
        {{ articleProgress.progressPercent }}% read
      </span>
    </div>

    <!-- Article Title -->
    <h1 class="article-title">{{ article.title }}</h1>

    <!-- Author Info -->
    <div class="author-section">
      <div class="author-info">
        <div [class]="'author-avatar ' + getAuthorAvatarColor(article.authorName)">
          {{ article.authorName.charAt(0).toUpperCase() }}
        </div>
        <div class="author-details">
          <h3 class="author-name">{{ article.authorName }}</h3>
          <p class="author-title">Content Creator</p>
        </div>
      </div>
    </div>

    <!-- Article Introduction -->
    <div class="article-intro">
      <p>{{ article.summary }}</p>
    </div>

    <!-- Progress Bar -->
    <div class="progress-section" *ngIf="isLogin">
      <div class="progress-header">
        <span class="progress-label">Tiến độ đọc</span>
        <span class="progress-percent">{{ getProgressPercent() }}%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getProgressPercent()"></div>
      </div>
    </div>

    <!-- Article Content Sections -->
    <div class="content-sections">
      <div *ngIf="article.sections && article.sections.length > 0; else noContent">
        <!-- Current Section -->
        <div class="section-card"
             [class.completed]="isSectionCompleted(currentSectionIndex)"
             [class.active]="true">
          
          <div class="section-header">
            <div class="section-number">
              <span class="section-current">{{ currentSectionIndex + 1 }}</span>
              <span class="section-divider">/</span>
              <span class="section-total">{{ article.sections.length }}</span>
            </div>
            <h2 class="section-title">
              {{ article.sections[currentSectionIndex].sectionTitle }}
            </h2>
            <div class="section-status-badge" *ngIf="isSectionCompleted(currentSectionIndex)">
              <i class="fas fa-check-circle"></i>
              <span>Đã hoàn thành</span>
            </div>
          </div>

          <div class="section-content" [innerHTML]="getCurrentSectionContent()"></div>

          <!-- Action Buttons -->
          <div class="section-actions">
            <button 
              *ngIf="isLogin && !isSectionCompleted(currentSectionIndex)"
              class="btn-mark-done" 
              (click)="markSectionAsDone()">
              <i class="fas fa-check-circle"></i>
              <span>Đánh dấu hoàn thành</span>
            </button>
            
            <button
              (click)="showReportPopup = true"
              class="btn-report">
              <i class="fas fa-flag"></i>
              <span>Báo cáo bài viết</span>
            </button>
          </div>

          @if (showReportPopup) {
            <app-report-popup
              [type]="'Article - ' + article.articleId + ' - Section - ' + currentSectionId"
              (close)="onReportPopupClose()"
            ></app-report-popup>
          }
        </div>

        <!-- Navigation -->
        <div class="section-navigation">
          <button
            (click)="previousSection()"
            [disabled]="currentSectionIndex === 0"
            class="nav-btn prev-btn">
            <i class="fas fa-chevron-left"></i>
            <span>Section trước</span>
          </button>

          <button
            (click)="nextSection()"
            [disabled]="currentSectionIndex === article.sections.length - 1"
            class="nav-btn next-btn">
            <span>Section tiếp theo</span>
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <!-- Section Navigator -->
        <div class="section-navigator" *ngIf="article && article.sections && article.sections.length > 0">
          <div class="navigator-header">
            <h4 class="navigator-title">
              <i class="fas fa-list"></i>
              Danh sách sections
            </h4>
          </div>
          <div class="section-buttons">
            <button
              *ngFor="let section of article.sections; let i = index"
              [class]="'section-btn ' + getSectionButtonClass(i)"
              (click)="goToSection(i)"
              [disabled]="!canAccessSection(i)"
              [title]="section.sectionTitle">
              <span class="btn-number">{{ i + 1 }}</span>
              <span class="btn-status" *ngIf="isSectionCompleted(i)">
                <i class="fas fa-check"></i>
              </span>
            </button>
          </div>
        </div>
      </div>
      
      <ng-template #noContent>
        <div class="no-content">
          <i class="fas fa-file-alt"></i>
          <p>Nội dung bài viết đang được cập nhật...</p>
        </div>
      </ng-template>
    </div>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="isLoading" class="loading-state">
  <div class="loading-spinner"></div>
  <p>Đang tải bài viết...</p>
</div>

<!-- Error State -->
<div *ngIf="error" class="error-state">
  <i class="fas fa-exclamation-circle"></i>
  <p>{{ error }}</p>
  <button (click)="loadArticle()" class="retry-btn">Thử lại</button>
</div>

<!-- Floating Chat Box & Note -->
@if(isLogin){
  <app-chat-box [contentArticle]="contentArticle"></app-chat-box>
  <app-note *ngIf="article" [articleId]="article.articleId" [sectionId]="currentSectionId"></app-note>
}
