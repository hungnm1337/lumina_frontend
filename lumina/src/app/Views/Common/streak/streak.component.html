<div class="streak-page">
  <!-- Loading State -->
  @if (loading) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>
  }

  <!-- Error State -->
  @else if (error) {
    <div class="error-container">
      <div class="error-icon">‚ùå</div>
      <h2>Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</h2>
      <p>Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c ƒëƒÉng nh·∫≠p l·∫°i.</p>
      <button (click)="goBack()" class="btn-primary">Quay l·∫°i</button>
    </div>
  }

  <!-- Main Content -->
  @else {
    <div class="streak-container">
      <!-- Header -->
      <div class="streak-header">
        <button (click)="goBack()" class="btn-back">
          <i class="fas fa-arrow-left"></i>
          Quay l·∫°i
        </button>
        <h1 class="page-title">
          <span class="fire-icon">üî•</span>
          Chu·ªói H·ªçc T·∫≠p
        </h1>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <!-- Current Streak -->
        <div class="stat-card current-streak" [style.border-color]="getStreakColor()">
          <!-- ‚úÖ THAY ƒê·ªîI: Th√™m fire animation -->
          <div 
            class="stat-icon fire-emoji"
            [class.seed]="getFireIntensity() === 'seed'"
            [class.gentle]="getFireIntensity() === 'gentle'"
            [class.strong]="getFireIntensity() === 'strong'"
            [class.intense]="getFireIntensity() === 'intense'"
          >
            {{ getFireEmoji() }}
          </div>
          <div class="stat-content">
            <div class="stat-label">Chu·ªói hi·ªán t·∫°i</div>
            <div class="stat-value" [style.color]="getStreakColor()">
              {{ currentStreak }}
              <span class="stat-unit">ng√†y</span>
            </div>
          </div>
        </div>

        <!-- Longest Streak -->
        <div class="stat-card">
          <div class="stat-icon">üèÜ</div>
          <div class="stat-content">
            <div class="stat-label">K·ª∑ l·ª•c c√° nh√¢n</div>
            <div class="stat-value">
              {{ longestStreak }}
              <span class="stat-unit">ng√†y</span>
            </div>
          </div>
        </div>

        <!-- Freeze Tokens -->
        <div class="stat-card">
          <div class="stat-icon">üíé</div>
          <div class="stat-content">
            <div class="stat-label">Freeze Tokens</div>
            <div class="stat-value">
              {{ freezeTokens }}
              <span class="stat-unit">token</span>
            </div>
          </div>
        </div>

        <!-- Last Practice -->
        <div class="stat-card">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-content">
            <div class="stat-label">H·ªçc l·∫ßn cu·ªëi</div>
            <div class="stat-value small">
              {{ formatDate(lastPracticeDate) }}
            </div>
          </div>
        </div>
      </div>

      <!-- Next Milestone Progress -->
      @if (nextMilestone) {
        <div class="next-milestone-card">
          <!-- Header Section -->
          <div class="milestone-header">
            <div class="milestone-title-section">
              <h3>üéØ M·ªëc ti·∫øp theo</h3>
              <p class="milestone-subtitle">{{ nextMilestone.reward }}</p>
            </div>
            <div class="milestone-target">
              <span class="milestone-icon">{{ nextMilestone.icon }}</span>
              <span class="milestone-days">{{ nextMilestone.days }} ng√†y</span>
            </div>
          </div>

          <!-- Progress Stats -->
          <div class="progress-stats">
            <div class="progress-stat">
              <div class="stat-number">{{ currentStreak }}</div>
              <div class="stat-label">Hi·ªán t·∫°i</div>
            </div>
            <div class="progress-stat">
              <div class="stat-number">{{ getDaysCompletedFromPrevious() }}/{{ getTotalDaysToNextMilestone() }}</div>
              <div class="stat-label">ƒê√£ ho√†n th√†nh</div>
            </div>
            <div class="progress-stat">
              <div class="stat-number">{{ getDaysUntilNextMilestone() }}</div>
              <div class="stat-label">C√≤n l·∫°i</div>
            </div>
          </div>

          <!-- Progress Bar Container -->
          <div class="progress-bar-container">
            <!-- Labels on top of progress bar -->
            <div class="progress-labels">
              <span class="progress-label-start">{{ getPreviousMilestoneDays() }} ng√†y</span>
              <span class="progress-label-current">
                <div class="current-indicator">
                  <span class="current-emoji">üî•</span>
                  <span class="current-value">{{ currentStreak }}</span>
                </div>
              </span>
              <span class="progress-label-end">{{ nextMilestone.days }} ng√†y</span>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar">
              <div 
                class="progress-fill" 
                [style.width.%]="progressPercent"
                [style.background]="'linear-gradient(90deg, ' + nextMilestone.color + ' 0%, ' + nextMilestone.color + 'dd 100%)'"
              >
                <span class="progress-percent">{{ progressPercent }}%</span>
              </div>
            </div>

            <!-- Progress Info -->
            <div class="progress-info">
              <span class="progress-text">
                B·∫°n ƒë√£ ho√†n th√†nh <strong>{{ progressPercent }}%</strong> h√†nh tr√¨nh ƒë·∫øn m·ªëc ti·∫øp theo
              </span>
            </div>
          </div>

          <!-- ‚úÖ UPDATE: Reward Section v·ªõi chi ti·∫øt -->
          <div class="milestone-rewards-grid">
            <!-- Freeze Tokens -->
            @if (nextMilestone.freezeTokens > 0) {
              <div class="reward-item freeze-token">
                <div class="reward-icon">üíé</div>
                <div class="reward-content">
                  <div class="reward-amount">+{{ nextMilestone.freezeTokens }}</div>
                  <div class="reward-label">Freeze Token{{ nextMilestone.freezeTokens > 1 ? 's' : '' }}</div>
                </div>
              </div>
            }

            <!-- Listening Tests -->
            @if (nextMilestone.listeningTests > 0) {
              <div class="reward-item listening-test">
                <div class="reward-icon">üéß</div>
                <div class="reward-content">
                  <div class="reward-amount">+{{ nextMilestone.listeningTests }}</div>
                  <div class="reward-label">Listening Test{{ nextMilestone.listeningTests > 1 ? 's' : '' }}</div>
                </div>
              </div>
            }

            <!-- Reading Tests -->
            @if (nextMilestone.readingTests > 0) {
              <div class="reward-item reading-test">
                <div class="reward-icon">üìñ</div>
                <div class="reward-content">
                  <div class="reward-amount">+{{ nextMilestone.readingTests }}</div>
                  <div class="reward-label">Reading Test{{ nextMilestone.readingTests > 1 ? 's' : '' }}</div>
                </div>
              </div>
            }
          </div>

          <!-- Motivation Message -->
          <div class="motivation-message">
            <span class="motivation-icon">üí™</span>
            <span class="motivation-text">
              Ch·ªâ c√≤n <strong>{{ getDaysUntilNextMilestone() }} ng√†y</strong> n·ªØa th√¥i!
            </span>
          </div>
        </div>
      }

      @else {
        <div class="max-milestone-card">
          <div class="celebration-icon">üéâ</div>
          <h3>Ch√∫c m·ª´ng!</h3>
          <p>B·∫°n ƒë√£ ƒë·∫°t t·∫•t c·∫£ c√°c m·ªëc milestone!</p>
          <div class="keep-going">H√£y ti·∫øp t·ª•c duy tr√¨ chu·ªói h·ªçc t·∫≠p nh√©! üí™</div>
        </div>
      }

      <!-- Milestones Timeline -->
      <div class="milestones-section">
        <h2 class="section-title">
          <i class="fas fa-trophy"></i>
          C·ªôt m·ªëc ph·∫ßn th∆∞·ªüng
        </h2>

        <div class="milestones-timeline">
          @for (milestone of milestones; track milestone.days) {
            <div 
              class="milestone-item"
              [class.reached]="milestone.reached"
              [class.current]="nextMilestone?.days === milestone.days"
            >
              <!-- Connector Line -->
              @if ($index < milestones.length - 1) {
                <div 
                  class="milestone-connector"
                  [class.active]="milestone.reached"
                ></div>
              }

              <!-- Milestone Node -->
              <div class="milestone-node" [style.background]="milestone.reached ? milestone.color : '#E5E7EB'">
                <div class="milestone-icon">{{ milestone.icon }}</div>
                
                @if (milestone.reached) {
                  <div class="milestone-check">
                    <i class="fas fa-check"></i>
                  </div>
                }
              </div>

              <!-- Milestone Info -->
              <div class="milestone-info">
                <div class="milestone-days" [style.color]="milestone.reached ? milestone.color : '#6B7280'">
                  {{ milestone.days }} ng√†y
                </div>
                <div class="milestone-reward-text">
                  {{ milestone.reward }}
                </div>

                @if (nextMilestone?.days === milestone.days) {
                  <div class="milestone-badge current-badge">
                    M·ª•c ti√™u ti·∫øp theo
                  </div>
                }

                @if (milestone.reached) {
                  <div class="milestone-badge reached-badge">
                    ‚úì ƒê√£ ƒë·∫°t
                  </div>
                }
              </div>

              <!-- Progress Bar for Current Milestone -->
              @if (nextMilestone?.days === milestone.days) {
                <div class="milestone-progress">
                  <div class="mini-progress-bar">
                    <div 
                      class="mini-progress-fill"
                      [style.width.%]="progressPercent"
                      [style.background]="milestone.color"
                    ></div>
                  </div>
                  <div class="mini-progress-text">{{ progressPercent }}%</div>
                </div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Freeze Tokens Info -->
      <div class="info-card">
        <div class="info-header">
          <i class="fas fa-info-circle"></i>
          <h3>Freeze Token l√† g√¨?</h3>
        </div>
        <div class="info-content">
          <p>
            üíé <strong>Freeze Token</strong> gi√∫p b·∫£o v·ªá chu·ªói h·ªçc t·∫≠p c·ªßa b·∫°n khi b·∫°n b·ªè l·ª° m·ªôt ng√†y.
          </p>
          <ul>
            <li>T·ª± ƒë·ªông s·ª≠ d·ª•ng khi b·∫°n l·ª° ng√†y h·ªçc</li>
            <li>Chu·ªói h·ªçc t·∫≠p s·∫Ω ƒë∆∞·ª£c gi·ªØ nguy√™n</li>
            <li>Nh·∫≠n th√™m token khi ƒë·∫°t c√°c m·ªëc milestone</li>
          </ul>
        </div>
      </div>

      <!-- Motivational Quote -->
      <div class="motivation-card">
        <div class="quote-icon">"</div>
        <p class="quote-text">
          Th√†nh c√¥ng l√† t·ªïng h·ª£p c·ªßa nh·ªØng n·ªó l·ª±c nh·ªè l·∫∑p ƒëi l·∫∑p l·∫°i m·ªói ng√†y
        </p>
        <div class="quote-author">- Robert Collier</div>
      </div>
    </div>
  }
</div>
