<app-header></app-header>

<div class="min-h-screen bg-slate-50 font-sans pb-6 sm:pb-4 relative">
    <div
        class="bg-gradient-to-b from-purple-800 via-purple-700 to-purple-600 text-white pb-6 rounded-b-[2rem] shadow-xl relative overflow-hidden">
        <div
            class="absolute top-0 left-0 w-64 h-64 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 -translate-x-1/2 -translate-y-1/2">
        </div>
        <div
            class="absolute bottom-0 right-0 w-64 h-64 bg-indigo-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 translate-x-1/2 translate-y-1/2">
        </div>

        <div class="max-w-md mx-auto px-4 pt-6 relative z-10">
            <!-- TITLE -->
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-yellow-300">
                        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                        <path d="M4 22h16" />
                        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
                        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
                        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
                    </svg>
                    Bảng Xếp Hạng
                </h1>
                <div
                    class="flex items-center gap-2 bg-white/10 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-medium border border-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                    </svg>
                    <span>Season 5: Còn 3 ngày</span>
                </div>
            </div>

            <!-- TAB SWITCHER -->
            <div class="bg-purple-900/40 p-1 rounded-xl flex mb-6 backdrop-blur-sm border border-white/10">
                <!-- Nút Điểm Tích Lũy -->
                <button (click)="setTab('points')"
                    class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-semibold transition-all duration-300"
                    [ngClass]="activeTab() === 'points' ? 'bg-white text-purple-700 shadow-lg' : 'text-purple-200 hover:text-white'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <circle cx="12" cy="12" r="6" />
                        <circle cx="12" cy="12" r="2" />
                    </svg>
                    Điểm Tích Lũy
                </button>
                
                <!-- Nút Chuỗi Streak -->
                <button (click)="setTab('streak')"
                    class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-sm font-semibold transition-all duration-300"
                    [ngClass]="activeTab() === 'streak' ? 'bg-white text-orange-600 shadow-lg' : 'text-purple-200 hover:text-white'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        [class]="activeTab() === 'streak' ? 'fill-orange-500 text-orange-500' : ''">
                        <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z" />
                    </svg>
                    Chuỗi Streak
                </button>
            </div>

            <p class="text-center text-purple-200 text-xs mb-2 opacity-80">
                {{ activeTab() === 'points' ? 'Điểm dựa trên kết quả bài thi Reading & Listening' : 'Số ngày học liên tiếp không gián đoạn' }}
            </p>

            <!-- PODIUM (Top 3) -->
            <div class="flex justify-center items-end gap-2 sm:gap-6 mb-8 pt-6 px-4" *ngIf="top3().length > 0">
                <!-- TOP 2 -->
                <div class="flex flex-col items-center w-1/3 max-w-[110px]">
                    <div class="mb-2 text-center w-full">
                        <span class="text-purple-200 font-bold text-sm truncate block w-full">{{ top3()[1]?.name }}</span>
                        <div class="flex items-center justify-center text-purple-100 text-xs font-medium bg-purple-800/40 px-2 py-0.5 rounded-full mt-1">
                            <ng-container *ngIf="activeTab() === 'points'; else streakIcon2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                {{ top3()[1]?.points | number }} XP
                            </ng-container>
                            <ng-template #streakIcon2>
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z" /></svg>
                                {{ top3()[1]?.streak }} Ngày
                            </ng-template>
                        </div>
                    </div>
                    <div class="relative">
                        <img [src]="top3()[1]?.avatar ? top3()[1]?.avatar : 'https://www.svgrepo.com/show/452030/avatar-default.svg'"
                            alt="avatar" class="w-20 h-20 rounded-full object-cover shadow-lg bg-white"
                            [ngClass]="top3()[1]?.isPro ? 'ring-4 ring-yellow-400' : 'ring-2 ring-purple-200'">
                        <div *ngIf="top3()[1]?.isPro" class="absolute -bottom-1 -right-1 bg-yellow-400 text-white text-[10px] px-1.5 rounded-full font-bold border border-white">PRO</div>
                        <div class="absolute -top-2 -left-2 w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold text-white shadow-md bg-gray-400">2</div>
                    </div>
                    <div class="w-full h-24 bg-purple-500/40 mt-3 rounded-t-lg relative border-t-4 border-gray-300 shadow-inner flex items-center justify-center">
                        <span class="text-4xl font-black text-white/20">2</span>
                    </div>
                </div>

                <!-- TOP 1 -->
                <div class="flex flex-col items-center w-1/3 max-w-[130px] -mt-8 z-10">
                    <div class="mb-2 text-center w-full">
                        <span class="text-white font-bold text-lg truncate block w-full drop-shadow-md">{{ top3()[0]?.name }}</span>
                        <div class="flex items-center justify-center text-yellow-300 text-sm font-bold bg-purple-900/60 px-3 py-1 rounded-full mt-1 border border-yellow-500/30">
                            <ng-container *ngIf="activeTab() === 'points'; else streakIcon1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                {{ top3()[0]?.points | number }} XP
                            </ng-container>
                            <ng-template #streakIcon1>
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z" /></svg>
                                {{ top3()[0]?.streak }} Ngày
                            </ng-template>
                        </div>
                    </div>
                    <div class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-yellow-400 drop-shadow-lg animate-bounce">
                            <circle cx="12" cy="8" r="7" />
                            <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" />
                        </svg>
                        <img [src]="top3()[0]?.avatar ? top3()[0]?.avatar : 'https://www.svgrepo.com/show/452030/avatar-default.svg'"
                            alt="avatar" class="w-24 h-24 rounded-full object-cover shadow-lg bg-white"
                            [ngClass]="top3()[0]?.isPro ? 'ring-4 ring-yellow-400' : 'ring-2 ring-purple-200'">
                        <div *ngIf="top3()[0]?.isPro" class="absolute -bottom-1 -right-1 bg-yellow-400 text-white text-[10px] px-1.5 rounded-full font-bold border border-white">PRO</div>
                        <div class="absolute -top-2 -left-2 w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold text-white shadow-md bg-yellow-500">1</div>
                    </div>
                    <div class="w-full h-32 bg-gradient-to-b from-purple-500 to-purple-600 mt-3 rounded-t-lg relative border-t-4 border-yellow-400 shadow-lg flex items-center justify-center">
                        <span class="text-5xl font-black text-white/20">1</span>
                    </div>
                </div>

                <!-- TOP 3 -->
                <div class="flex flex-col items-center w-1/3 max-w-[110px]">
                    <div class="mb-2 text-center w-full">
                        <span class="text-purple-200 font-bold text-sm truncate block w-full">{{ top3()[2]?.name }}</span>
                        <div class="flex items-center justify-center text-purple-100 text-xs font-medium bg-purple-800/40 px-2 py-0.5 rounded-full mt-1">
                            <ng-container *ngIf="activeTab() === 'points'; else streakIcon3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                {{ top3()[2]?.points | number }} XP
                            </ng-container>
                            <ng-template #streakIcon3>
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z" /></svg>
                                {{ top3()[2]?.streak }} Ngày
                            </ng-template>
                        </div>
                    </div>
                    <div class="relative">
                        <img [src]="top3()[2]?.avatar ? top3()[2]?.avatar : 'https://www.svgrepo.com/show/452030/avatar-default.svg'"
                            alt="avatar" class="w-20 h-20 rounded-full object-cover shadow-lg bg-white"
                            [ngClass]="top3()[2]?.isPro ? 'ring-4 ring-yellow-400' : 'ring-2 ring-purple-200'">
                        <div *ngIf="top3()[2]?.isPro" class="absolute -bottom-1 -right-1 bg-yellow-400 text-white text-[10px] px-1.5 rounded-full font-bold border border-white">PRO</div>
                        <div class="absolute -top-2 -left-2 w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold text-white shadow-md bg-orange-600">3</div>
                    </div>
                    <div class="w-full h-16 bg-purple-500/30 mt-3 rounded-t-lg relative border-t-4 border-orange-600 shadow-inner flex items-center justify-center">
                        <span class="text-4xl font-black text-white/20">3</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LIST SECTION (Rank 4+) -->
    <div class="max-w-md mx-auto px-4 -mt-4 relative z-20 pb-6">
        <div class="flex flex-col gap-1">
            <ng-container *ngIf="!loading() && restOfList().length > 0; else noData">
                <div *ngFor="let user of restOfList(); let idx = index"
                    class="flex items-center justify-between p-3 mb-2 rounded-xl transition-all border-b-2 bg-white border-slate-100 hover:bg-slate-50">
                    <div class="flex items-center gap-3 sm:gap-4 flex-1 overflow-hidden">
                        <div class="w-8 font-bold text-center text-slate-400">
                            {{ idx + 4 }}
                        </div>
                        <div class="relative flex-shrink-0">
                            <img [src]="user.avatar ? user.avatar : 'https://www.svgrepo.com/show/452030/avatar-default.svg'"
                                [alt]="user.name" class="w-10 h-10 rounded-full object-cover"
                                [ngClass]="user.isPro ? 'ring-2 ring-yellow-400' : 'ring-1 ring-slate-200'">
                             <div *ngIf="user.isPro" class="absolute -bottom-1 -right-1 w-3 h-3 bg-yellow-400 rounded-full border border-white"></div>
                        </div>
                        <div class="flex flex-col truncate">
                            <span class="font-semibold text-sm sm:text-base truncate text-slate-700">
                                {{ user.name }}
                            </span>
                            <span class="text-xs text-slate-500">
                                {{ user.isPro ? 'Học viên Pro' : 'Học viên' }}
                            </span>
                        </div>
                    </div>
                    <div class="text-right pl-2">
                        <div class="font-bold text-sm sm:text-base flex items-center justify-end gap-1"
                            [ngClass]="activeTab() === 'streak' ? 'text-orange-500' : 'text-purple-600'">
                            
                            <ng-container *ngIf="activeTab() === 'points'; else streakListItem">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                {{ user.points | number }}
                            </ng-container>
                            <ng-template #streakListItem>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z" /></svg>
                                {{ user.streak }}
                            </ng-template>
                        </div>
                        <span class="text-[10px] text-slate-400 uppercase font-medium">
                            {{ activeTab() === 'streak' ? 'Ngày' : 'Điểm' }}
                        </span>
                    </div>
                </div>
            </ng-container>
            <ng-template #noData>
                <div class="text-center py-10 text-slate-400">
                    <p>Chưa có dữ liệu bảng xếp hạng</p>
                </div>
            </ng-template>
        </div>
    </div>
</div>