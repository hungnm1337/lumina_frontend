
<div class="vocabulary-container">
  <div *ngIf="currentView === 'lists'">

    <div class="page-header">
      <div class="header-content">
        <div class="title-section">
          <h1 class="page-title">
            <span class="toeic-badge">TOEIC</span>
            Vocabulary Management
          </h1>
          <p class="page-subtitle">
            Organize your vocabulary into lists for focused learning
          </p>
        </div>
        <div class="header-stats">
          <div class="stat-card">
            <div class="stat-number">{{vocabularyLists.length || 0}}</div>
            <div class="stat-label">Total Lists</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{getPendingCount()}}</div>
            <div class="stat-label">Pending</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{getPublishedCount()}}</div>
            <div class="stat-label">Published</div>
          </div>
        </div>
      </div>
      <button class="btn-primary" (click)="openCreateListModal()"><i class="fas fa-folder-plus"></i> Add New List</button>
    </div>

    <div class="search-filter-panel">
      <div class="search-section">
        <div class="search-input-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="onSearchInput($event)" placeholder="Search vocabulary lists..." class="search-input">
          <button *ngIf="searchTerm" (click)="clearSearch()" class="clear-search-btn"><i class="fas fa-times"></i></button>
        </div>
      </div>
    </div>


    <div *ngIf="isLoading" class="loading-state">
      <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div><p>Loading lists...</p>
    </div>
    <div *ngIf="!isLoading && vocabularyLists.length > 0" class="folder-grid">
      <div *ngFor="let list of vocabularyLists" 
           class="folder-card" 
           [class.featured]="list.status?.toLowerCase() === 'published'"
           [class.pending-card]="list.status?.toLowerCase() === 'pending'"
           [class.rejected-card]="list.rejectionReason"
           (click)="selectList(list)">
        <div class="card-header">
          <div class="list-icon-section">
            <div class="folder-icon"><i class="fas fa-folder"></i></div>
            <div class="list-info">
              <h3 class="folder-name">{{ list.name }}</h3>
              <p class="folder-meta">{{ list.vocabularyCount }} words · Created by {{ list.makeByName }}</p>
            </div>
          </div>
          <div class="folder-status-right">
            <div *ngIf="list.status?.toLowerCase() === 'published'" class="status-badge-published">
              <i class="fas fa-check-circle"></i>
              <div class="status-text-wrapper">
                <span class="status-line-1">Approved</span>
                <span class="status-line-2">& Published</span>
              </div>
            </div>
            <div *ngIf="list.status?.toLowerCase() === 'pending'" class="status-info status-pending">
              <i class="fas fa-clock"></i>
              <span>Waiting for approval</span>
            </div>
            <div *ngIf="list.status?.toLowerCase() === 'draft' || list.status?.toLowerCase() === 'rejected'" class="action-buttons">
              <button class="btn-request-approval" (click)="requestApproval(list, $event); $event.stopPropagation()" 
                      [disabled]="isSubmitting">
                <i class="fas fa-paper-plane"></i> 
                <span *ngIf="!isSubmitting">Send for Review</span>
                <span *ngIf="isSubmitting">Sending...</span>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Rejection Reason Alert -->
        <div *ngIf="list.rejectionReason" class="rejection-alert-wrapper">
          <div class="rejection-alert">
            <div class="alert-header">
              <i class="fas fa-exclamation-triangle"></i>
              <span class="alert-title">Danh sách từ vựng đã bị từ chối</span>
            </div>
            <div class="alert-content">
              <p class="rejection-reason">{{ list.rejectionReason }}</p>
              <p class="rejection-hint">
                <i class="fas fa-info-circle"></i>
                Vui lòng sửa lại danh sách theo góp ý và gửi lại để duyệt.
              </p>
            </div>
          </div>
        </div>
        
        <div class="folder-footer">
          <button *ngIf="list.status?.toLowerCase() === 'published'" class="btn-published" (click)="$event.stopPropagation()">
            ĐÃ XUẤT BẢN
          </button>
          <div class="folder-arrow"><i class="fas fa-chevron-right"></i></div>
        </div>
      </div>
    </div>
    <div *ngIf="!isLoading && vocabularyLists.length === 0" class="empty-state">
      <div class="empty-icon"><i class="fas fa-folder-open"></i></div>
      <h3>No vocabulary lists found</h3>
      <p>Create your first list to start adding words. Remember to send for review when ready!</p>
      <button class="btn-add-first" (click)="openCreateListModal()"><i class="fas fa-plus"></i> Create First List</button>
    </div>
  </div>
  <div *ngIf="currentView === 'words' && selectedList">
    <div class="page-header">
      <div class="header-content">
        <button class="btn-back" (click)="showListView()"><i class="fas fa-arrow-left"></i> Back to Lists</button>
        <div class="title-section">
          <h1 class="page-title">
            <i class="fas fa-folder-open folder-title-icon"></i> 
            {{ selectedList.name }}
            <span class="word-count-badge">{{ selectedList.vocabularyCount }} words</span>
          </h1>
          <p class="page-subtitle">
            Manage all words inside this list
          </p>
        </div>
      </div>
      <button class="btn-primary" (click)="openModal()"><i class="fas fa-plus"></i> Add New Word</button>
    </div>

    <div class="search-filter-panel">
      <div class="search-section">
        <div class="search-input-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="onSearchInput($event)" placeholder="Search words in this list..." class="search-input">
          <button *ngIf="searchTerm" (click)="clearSearch()" class="clear-search-btn"><i class="fas fa-times"></i></button>
        </div>
      </div>
    </div>
    

    <div class="main-content">
      <div class="vocabulary-list-section">
        <div *ngIf="isLoading" class="loading-state">
          <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div><p>Loading vocabulary...</p>
        </div>
        <div *ngIf="!isLoading" class="vocabulary-grid">
          <div *ngFor="let vocab of pagedVocabularies" class="vocabulary-card">
            <!-- Card Top Section -->
            <div class="card-top">
              <div class="word-main">
                <div class="word-header">
                  <h3 class="word-title" (click)="speakWord(vocab.word)">
                    {{vocab.word}}
                    <button class="btn-speak" (click)="speakWord(vocab.word); $event.stopPropagation()" title="Pronounce">
                      <i class="fas fa-volume-up"></i>
                    </button>
                  </h3>
                  <div class="word-pronunciation" *ngIf="vocab.pronunciation">
                    <i class="fas fa-language"></i>
                    {{vocab.pronunciation}}
                  </div>
                </div>
                <div class="word-badges">
                  <span class="pos-badge">{{vocab.partOfSpeech}}</span>
                  <span class="category-badge">
                    <i class="fas fa-tag"></i>
                    {{getCategoryName(vocab.category)}}
                  </span>
                </div>
              </div>
              <div class="card-actions-menu">
                <button class="btn-action btn-edit" (click)="openModal(vocab); $event.stopPropagation()" title="Edit word">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn-action btn-delete" (click)="deleteVocabulary(vocab.id); $event.stopPropagation()" title="Delete word">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>

            <!-- Card Content Section -->
            <div class="card-body">
              <!-- Image Section -->
              <div *ngIf="vocab.imageUrl" class="vocab-image-section">
                <img [src]="vocab.imageUrl" [alt]="'Image for ' + vocab.word" class="vocab-image" 
                     (error)="handleImageError($event, vocab)" />
              </div>
              
              <div class="translation-box">
                <i class="fas fa-language translation-icon"></i>
                <span class="translation-text">{{vocab.translation}}</span>
              </div>
              
              <div class="definition-box">
                <div class="definition-label">
                  <i class="fas fa-book"></i>
                  <span>Definition</span>
                </div>
                <p class="definition-content">{{vocab.definition}}</p>
              </div>

              <div class="example-box" *ngIf="vocab.example">
                <div class="example-label">
                  <i class="fas fa-quote-left"></i>
                  <span>Example</span>
                </div>
                <p class="example-content">"{{vocab.example}}"</p>
              </div>
            </div>
          </div>
        </div>
        
        <div *ngIf="!isLoading && pagedVocabularies.length === 0" class="empty-state">
          <div class="empty-icon"><i class="fas fa-box-open"></i></div><h3>This list is empty</h3><p>Start by adding the first vocabulary word to this list.</p>
          <button class="btn-add-first" (click)="openModal()"><i class="fas fa-plus"></i> Add First Word</button>
        </div>
        <div *ngIf="!isLoading && totalPages > 1" class="pagination-section">
          <div class="pagination-info">
            Showing {{getStartIndex()}} - {{getEndIndex()}} of {{totalItems}} words
          </div>
          <div class="pagination-controls">
            <button class="btn-page btn-prev" [disabled]="page <= 1" (click)="prevPage()">
              <i class="fas fa-chevron-left"></i>
              <span>Previous</span>
            </button>
            <div class="page-numbers">
              <button *ngFor="let pageNum of getPageNumbers()" 
                      class="page-number" 
                      [class.active]="pageNum === page"
                      (click)="goToPage(pageNum)">
                {{pageNum}}
              </button>
            </div>
            <button class="btn-page btn-next" [disabled]="page >= totalPages || totalItems === 0" (click)="nextPage()">
              <span>Next</span>
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
<div *ngIf="isListModalOpen" class="modal-overlay" (click)="closeCreateListModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-header-content">
        <div class="modal-icon"><i class="fas fa-folder-plus"></i></div>
        <div class="modal-title-section">
          <h2>Create New Vocabulary List</h2>
          <p>Start a new collection of words</p>
        </div>
      </div>
      <button class="btn-close" (click)="closeCreateListModal()"><i class="fas fa-times"></i></button>
    </div>
    <form [formGroup]="listForm" (ngSubmit)="saveNewList()" class="modal-form">
      <div class="form-group">
        <label for="list-name">List Name *</label>
        <input id="list-name" type="text" formControlName="name" placeholder="e.g., TOEIC Business Vocabulary" class="form-input">
        <div *ngIf="listForm.get('name')?.invalid && listForm.get('name')?.touched" class="error-message">
          <span *ngIf="listForm.get('name')?.errors?.['required']">
            List name is required.
          </span>
          <span *ngIf="listForm.get('name')?.errors?.['minlength']">
            List name must be at least 3 characters.
          </span>
          <span *ngIf="listForm.get('name')?.errors?.['maxlength']">
            List name must not exceed 100 characters.
          </span>
          <span *ngIf="listForm.get('name')?.errors?.['pattern']">
            List name can only contain letters, numbers, spaces, hyphens, and underscores.
          </span>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeCreateListModal()">Cancel</button>
        <button type="submit" class="btn-primary" [disabled]="listForm.invalid || isSubmitting">
          <i *ngIf="isSubmitting" class="fas fa-spinner fa-spin"></i>
          Create List
        </button>
      </div>
    </form>
  </div>
</div>
<div *ngIf="isModalOpen" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content vocabulary-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-header-content">
        <div class="modal-icon">
          <i class="fas fa-book-medical"></i>
        </div>
        <div class="modal-title-section">
          <h2>{{ editingVocabulary ? 'Edit Vocabulary' : 'Add New Vocabulary' }}</h2>
          <p>Build your TOEIC vocabulary collection</p>
        </div>
      </div>
      <button class="btn-close" (click)="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <form [formGroup]="vocabularyForm" (ngSubmit)="saveVocabulary()" class="modal-form">
  
      <div class="form-group full-width">
        <label for="word">ENGLISH WORD <span class="required">*</span></label>
        <input
          id="word"
          type="text"
          formControlName="word"
          class="form-input"
          placeholder="Enter English word"
        />
        <div *ngIf="vocabularyForm.get('word')?.invalid && vocabularyForm.get('word')?.touched" class="error-message">
          <span *ngIf="vocabularyForm.get('word')?.errors?.['required']">
            English word is required.
          </span>
          <span *ngIf="vocabularyForm.get('word')?.errors?.['minlength']">
            Word must be at least 1 character.
          </span>
          <span *ngIf="vocabularyForm.get('word')?.errors?.['maxlength']">
            Word must not exceed 100 characters.
          </span>
          <span *ngIf="vocabularyForm.get('word')?.errors?.['pattern']">
            Word can only contain letters, spaces, hyphens, and apostrophes.
          </span>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="partOfSpeech">PART OF SPEECH <span class="required">*</span></label>
          <select id="partOfSpeech" formControlName="partOfSpeech" class="form-select">
            <option value="">Select part of speech</option>
            <option *ngFor="let pos of partsOfSpeech" [value]="pos">{{ pos }}</option>
          </select>
          <div *ngIf="vocabularyForm.get('partOfSpeech')?.invalid && vocabularyForm.get('partOfSpeech')?.touched" class="error-message">
            <span *ngIf="vocabularyForm.get('partOfSpeech')?.errors?.['required']">
              Part of speech is required.
            </span>
            <span *ngIf="vocabularyForm.get('partOfSpeech')?.errors?.['pattern']">
              Please select a valid part of speech.
            </span>
          </div>
        </div>

        <div class="form-group">
          <label for="category">CATEGORY <span class="required">*</span></label>
          <input
            id="category"
            type="text"
            formControlName="category"
            class="form-input"
            placeholder="Enter category (e.g., Business, Technology, Travel...)"
            list="category-suggestions"
          />
          <datalist id="category-suggestions">
            <option *ngFor="let category of categories" [value]="category.name"></option>
          </datalist>
          <div *ngIf="vocabularyForm.get('category')?.invalid && vocabularyForm.get('category')?.touched" class="error-message">
            <span *ngIf="vocabularyForm.get('category')?.errors?.['required']">
              Category is required.
            </span>
            <span *ngIf="vocabularyForm.get('category')?.errors?.['maxlength']">
              Category must not exceed 50 characters.
            </span>
            <span *ngIf="vocabularyForm.get('category')?.errors?.['pattern']">
              Category can only contain letters, spaces, and hyphens.
            </span>
          </div>
        </div>

      </div>

      <!-- Definition -->
      <div class="form-group full-width">
        <label for="definition">DEFINITION <span class="required">*</span></label>
        <textarea
          id="definition"
          formControlName="definition"
          rows="3"
          class="form-textarea"
          placeholder="Enter word definition"
        ></textarea>
        <div *ngIf="vocabularyForm.get('definition')?.invalid && vocabularyForm.get('definition')?.touched" class="error-message">
          <span *ngIf="vocabularyForm.get('definition')?.errors?.['required']">
            Definition is required.
          </span>
          <span *ngIf="vocabularyForm.get('definition')?.errors?.['maxlength']">
            Definition must not exceed 1000 characters.
          </span>
        </div>
      </div>

      <!-- Vietnamese Translation -->
      <div class="form-group full-width">
        <label for="translation">VIETNAMESE TRANSLATION <span class="required">*</span></label>
        <textarea
          id="translation"
          formControlName="translation"
          rows="2"
          class="form-textarea"
          placeholder="Enter Vietnamese translation"
        ></textarea>
        <div *ngIf="vocabularyForm.get('translation')?.invalid && vocabularyForm.get('translation')?.touched" class="error-message">
          <span *ngIf="vocabularyForm.get('translation')?.errors?.['required']">
            Translation is required.
          </span>
          <span *ngIf="vocabularyForm.get('translation')?.errors?.['maxlength']">
            Translation must not exceed 500 characters.
          </span>
        </div>
      </div>

      <!-- Example Sentence -->
      <div class="form-group full-width">
        <label for="example">EXAMPLE SENTENCE <span class="required">*</span></label>
        <textarea
          id="example"
          formControlName="example"
          rows="3"
          class="form-textarea"
          placeholder="Enter example sentence"
        ></textarea>
        <div *ngIf="vocabularyForm.get('example')?.invalid && vocabularyForm.get('example')?.touched" class="error-message">
          <span *ngIf="vocabularyForm.get('example')?.errors?.['required']">
            Example sentence is required.
          </span>
          <span *ngIf="vocabularyForm.get('example')?.errors?.['maxlength']">
            Example sentence must not exceed 500 characters.
          </span>
        </div>
      </div>

      <!-- Image Upload -->
      <div class="form-group full-width">
        <label for="vocab-image">Image (optional)</label>
        
        <!-- Current Image Preview -->
        <div *ngIf="imagePreview" class="image-preview-container">
          <img [src]="imagePreview" alt="Vocabulary image" class="image-preview" />
          <button type="button" class="btn-remove-image" (click)="removeImage()" title="Remove image">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <!-- Image Upload Controls -->
        <div class="image-upload-controls">
          <input
            type="file"
            id="vocab-image-input"
            accept="image/*"
            (change)="onImageSelected($event)"
            class="image-input"
            [disabled]="isUploadingImage || isSubmitting"
          />
          <label for="vocab-image-input" class="btn-upload-image" [class.disabled]="isUploadingImage || isSubmitting">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            <span>{{ imagePreview ? 'Change Image' : 'Select Image' }}</span>
          </label>
        </div>
        
        <p class="image-upload-hint">Chọn ảnh để upload lên Cloudinary khi lưu (tối đa 5MB)</p>
      </div>

      <!-- Actions -->
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeModal()">
          Cancel
        </button>
        <button type="submit" class="btn-primary" [disabled]="vocabularyForm.invalid || isSubmitting || isUploadingImage">
          <i *ngIf="isSubmitting || isUploadingImage" class="fas fa-spinner fa-spin"></i>
          <span *ngIf="!isSubmitting && !isUploadingImage">{{ editingVocabulary ? 'Update Word' : 'Add Word' }}</span>
          <span *ngIf="isUploadingImage && !isSubmitting">Uploading image...</span>
          <span *ngIf="isSubmitting && !isUploadingImage">{{ editingVocabulary ? 'Updating...' : 'Saving...' }}</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Confirmation Modal -->
<div *ngIf="showConfirmModal" class="modal-overlay" (click)="closeConfirmModal()">
  <div class="modal-content modal-confirm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-header-content">
        <div class="modal-icon" [ngClass]="{'icon-danger': confirmType === 'delete', 'icon-warning': confirmType === 'approval'}">
          <i *ngIf="confirmType === 'delete'" class="fas fa-exclamation-triangle"></i>
          <i *ngIf="confirmType === 'approval'" class="fas fa-paper-plane"></i>
        </div>
        <div class="modal-title-section">
          <h2>{{confirmTitle}}</h2>
        </div>
      </div>
      <button class="btn-close" (click)="closeConfirmModal()" type="button">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <p class="confirm-message">{{confirmMessage}}</p>
      <p *ngIf="confirmType === 'delete'" class="confirm-warning">
        <i class="fas fa-info-circle"></i>
        Thao tác này không thể hoàn tác!
      </p>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn-secondary" (click)="closeConfirmModal()" [disabled]="isSubmitting || isLoading">
        Hủy
      </button>
      <button
        type="button"
        class="btn-primary"
        [ngClass]="{'btn-danger': confirmType === 'delete', 'btn-warning': confirmType === 'approval'}"
        (click)="confirmType === 'delete' ? confirmDelete() : confirmApproval()"
        [disabled]="isSubmitting || isLoading">
        <i *ngIf="isSubmitting || isLoading" class="fas fa-spinner fa-spin"></i>
        <i *ngIf="!isSubmitting && !isLoading && confirmType === 'delete'" class="fas fa-trash"></i>
        <i *ngIf="!isSubmitting && !isLoading && confirmType === 'approval'" class="fas fa-paper-plane"></i>
        <span *ngIf="!isSubmitting && !isLoading">{{confirmType === 'delete' ? 'Xóa' : 'Gửi phê duyệt'}}</span>
        <span *ngIf="isSubmitting || isLoading">Đang xử lý...</span>
      </button>
    </div>
  </div>
</div>
