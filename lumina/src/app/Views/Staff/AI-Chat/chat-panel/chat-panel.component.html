<div class="chat-panel">

  <div #messagesContainer class="messages-container">
    <ng-container *ngIf="messages?.length; else empty">
      <div *ngFor="let message of messages" class="message-wrapper">
        <app-message-item [message]="message"></app-message-item>
        
        <!-- Nút xem preview nếu message có previewId và chưa lưu -->
        <div class="preview-action" *ngIf="message.previewId && message.role === 'assistant' && !isPreviewSaved(message.previewId)">
          <button class="view-preview-btn" (click)="onPreviewClick(message.previewId)">
            <i class="fas fa-eye"></i>
            Xem lại đề thi này
          </button>
        </div>
        
        <!-- Thông báo đã lưu -->
        <div class="preview-saved-badge" *ngIf="message.previewId && message.role === 'assistant' && isPreviewSaved(message.previewId)">
          <i class="fas fa-check-circle"></i>
          Đề thi đã được lưu
        </div>
      </div>
    </ng-container>

    <ng-template #empty>
      <div class="empty-placeholder">
        <i class="fas fa-comments" style="font-size: 48px; color: #cbd5e1; margin-bottom: 16px;"></i>
        <p style="color: #94a3b8;">Chưa có tin nhắn</p>
      </div>
    </ng-template>

    <div class="loading-indicator" *ngIf="isLoading">
      <div class="typing-dots">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>

  <div class="input-container">
    <textarea
      [(ngModel)]="newMessage"
      placeholder="Vd: Tạo 5 câu Reading Part 5 về giới từ"
      (keydown.enter)="onEnter($event)"
      rows="1"></textarea>

    <button 
      (click)="sendMessage()" 
      [disabled]="!newMessage.trim() || isLoading">
      <i class="fas fa-paper-plane"></i>
    </button>
  </div>
</div>