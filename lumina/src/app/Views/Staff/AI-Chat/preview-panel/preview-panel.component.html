<div class="preview-panel" *ngIf="previewData && previewData.length > 0">
  <!-- âœ… Toast Notification -->
  <div class="toast" [class.show]="showToast">
    {{ toastMessage }}
  </div>

  <div class="panel-header">
    <h2>ğŸ‘ï¸ Preview</h2>
    
    <div class="selector-group">
      <!-- âœ… Hiá»ƒn thá»‹ loading state -->
      <div *ngIf="isLoadingParts" class="loading-indicator">
        Äang táº£i...
      </div>
      
      <!-- âœ… Chá»‰ hiá»ƒn thá»‹ khi cÃ³ dá»¯ liá»‡u -->
      <div *ngIf="!isLoadingParts && examSetKeys.length > 0" class="selector-controls">
        <!-- Chá»n ExamSetKey -->
        <select [(ngModel)]="selectedExamSetKey" (change)="onExamSetKeyChange()" class="select-examset">
          <option [value]="null">Chá»n ká»³ Ä‘á»</option>
          <option *ngFor="let key of examSetKeys" [ngValue]="key">{{ key }}</option>
        </select>
        
        <!-- Chá»n PartCode (theo lá»c) -->
        <select *ngIf="filteredParts.length > 0" [(ngModel)]="selectedPartId" (change)="onPartChange()" class="select-part">
          <option [value]="null">Chá»n Part</option>
          <option *ngFor="let part of filteredParts" [value]="part.partId">
            {{ part.partCode }} - {{ part.title }}
          </option>
        </select>

        <!-- âœ… NÃºt LÆ°u (chá»‰ hiá»ƒn thá»‹ khi Ä‘Ã£ chá»n cáº£ 2) -->
        <button 
          *ngIf="selectedExamSetKey && selectedPartId" 
          (click)="onSaveExam()"
          class="btn-save"
          [disabled]="isSaving">
          <span *ngIf="!isSaving">ğŸ’¾ LÆ°u Ä‘á» thi</span>
          <span *ngIf="isSaving">â³ Äang lÆ°u...</span>
        </button>
      </div>

      <!-- âœ… Hiá»ƒn thá»‹ message náº¿u khÃ´ng cÃ³ dá»¯ liá»‡u -->
      <div *ngIf="!isLoadingParts && examSetKeys.length === 0" class="no-data-message">
        KhÃ´ng cÃ³ dá»¯ liá»‡u ká»³ Ä‘á»
      </div>
    </div>
  </div>


  <div class="preview-content">
    <!-- Loop qua tá»«ng Prompt -->
    <div class="prompt-section" *ngFor="let prompt of previewData; let pIdx = index">
      <!-- Prompt Info -->
      <div class="prompt-info">
        <h3>
          <span class="prompt-badge">Prompt {{ pIdx + 1 }}</span>
          {{ prompt.title }}
        </h3>
        <div class="prompt-meta">
          <span class="meta-item">ğŸ¯ {{ prompt.skill }}</span>
          <span class="meta-item" *ngIf="prompt.questions && prompt.questions.length > 0">
            ğŸ“Š {{ prompt.questions.length }} cÃ¢u há»i
          </span>
        </div>
        <p class="prompt-description">{{ prompt.contentText }}</p>
      </div>

      <div class="media-image" *ngIf="prompt.referenceImageUrl && prompt.referenceImageUrl.startsWith('http')">
        <img [src]="prompt.referenceImageUrl" alt="AI Generated Image" />
      </div>

      <!-- âœ… Audio Player - Náº¿u lÃ  URL
      <div class="media-audio" *ngIf="prompt.referenceAudioUrl && prompt.referenceAudioUrl.startsWith('http')">
        <div class="media-label">
          <span class="icon">ğŸ”Š</span>
          <strong>Audio Reference</strong>
        </div>
        <audio controls class="audio-player">
          <source [src]="prompt.referenceAudioUrl" type="audio/mpeg">
          TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ audio.
        </audio>
      </div> -->

      <!-- âœ… Audio Text Description - Náº¿u lÃ  text -->
      <div class="media-description" *ngIf="prompt.referenceAudioUrl && !prompt.referenceAudioUrl.startsWith('http')">
        <div class="media-label">
          <span class="icon">ğŸ”Š</span>
          <strong>Ná»™i dung Audio</strong>
        </div>
        <div class="media-content">{{ prompt.referenceAudioUrl }}</div>
        <div class="media-note">ğŸ’¡ Audio sáº½ Ä‘Æ°á»£c táº¡o khi lÆ°u Ä‘á» thi</div>
      </div>

      <!-- âœ… Questions List -->
      <div class="questions-container" *ngIf="prompt.questions && prompt.questions.length > 0">
        <div class="question-card" *ngFor="let q of prompt.questions; let qIdx = index">
          <!-- Question Header -->
          <div class="question-header">
            <span class="question-number">CÃ¢u {{ qIdx + 1 }}</span>
            <div class="question-meta">
              <span class="meta-tag" *ngIf="q.question?.time">â±ï¸ {{ q.question.time }}s</span>
              <span class="meta-tag" *ngIf="q.question?.scoreWeight">ğŸ’¯ {{ q.question.scoreWeight }} Ä‘iá»ƒm</span>
            </div>
          </div>

          <!-- Question Text -->
          <div class="question-text" *ngIf="q.question?.stemText">
            {{ q.question.stemText }}
          </div>

          <!-- âœ… Options (Chá»‰ hiá»ƒn thá»‹ náº¿u tá»“n táº¡i vÃ  cÃ³ ná»™i dung) -->
          <div class="options-grid" *ngIf="q.options && q.options.length > 0">
            <div class="option-item" *ngFor="let opt of q.options; let oIdx = index" [class.correct]="opt.isCorrect">
              <div class="option-header">
                <span class="option-letter">{{ getOptionLabel(oIdx) }}</span>
                <span class="correct-icon" *ngIf="opt.isCorrect">âœ“</span>
              </div>
              <div class="option-content" *ngIf="opt.content">
                {{ opt.content }}
              </div>
            </div>
          </div>

          <!-- âœ… Explanation -->
          <div class="explanation-box" *ngIf="q.question?.questionExplain">
            <div class="explanation-header">
              <span class="icon">ğŸ’¡</span>
              <strong>Giáº£i thÃ­ch</strong>
            </div>
            <div class="explanation-content">
              {{ q.question.questionExplain }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>