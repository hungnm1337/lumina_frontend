<div class="preview-panel" *ngIf="previewData && previewData.length > 0">
  <!-- ‚úÖ Toast Notification -->
  <div class="toast" [class.show]="showToast">
    {{ toastMessage }}
  </div>

  <div class="panel-header">
    <h2>üëÅÔ∏è Preview</h2>
    
    <div class="selector-group">
      <!-- ‚úÖ Hi·ªÉn th·ªã loading state -->
      <div *ngIf="isLoadingParts" class="loading-indicator">
        ƒêang t·∫£i...
      </div>
      
      <!-- ‚úÖ Ch·ªâ hi·ªÉn th·ªã khi c√≥ d·ªØ li·ªáu -->
      <div *ngIf="!isLoadingParts && examSetKeys.length > 0" class="selector-controls">
        <!-- Ch·ªçn ExamSetKey -->
        <select [(ngModel)]="selectedExamSetKey" (change)="onExamSetKeyChange()" class="select-examset">
          <option [value]="null">Ch·ªçn k·ª≥ ƒë·ªÅ</option>
          <option *ngFor="let key of examSetKeys" [ngValue]="key">{{ key }}</option>
        </select>
        
        <!-- Ch·ªçn PartCode (theo l·ªçc) -->
        <select *ngIf="filteredParts.length > 0" [(ngModel)]="selectedPartId" (change)="onPartChange()" class="select-part">
          <option [value]="null">Ch·ªçn Part</option>
          <option *ngFor="let part of filteredParts" [value]="part.partId">
            {{ part.partCode }} - {{ part.title }}
          </option>
        </select>

        <!-- ‚úÖ N√∫t L∆∞u (ch·ªâ hi·ªÉn th·ªã khi ƒë√£ ch·ªçn c·∫£ 2) -->
        <button 
          *ngIf="selectedExamSetKey && selectedPartId" 
          (click)="onSaveExam()"
          class="btn-save"
          [disabled]="isSaving">
          <span *ngIf="!isSaving">üíæ L∆∞u ƒë·ªÅ thi</span>
          <span *ngIf="isSaving">‚è≥ ƒêang l∆∞u...</span>
        </button>
      </div>

      <!-- ‚úÖ Hi·ªÉn th·ªã message n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu -->
      <div *ngIf="!isLoadingParts && examSetKeys.length === 0" class="no-data-message">
        Kh√¥ng c√≥ d·ªØ li·ªáu k·ª≥ ƒë·ªÅ
      </div>
    </div>
  </div>


  <div class="preview-content">
    <!-- Loop qua t·ª´ng Prompt -->
    <div class="prompt-section" *ngFor="let prompt of previewData; let pIdx = index">
      <!-- Prompt Info -->
      <div class="prompt-info">
        <h3>
          <span class="prompt-badge">Prompt {{ pIdx + 1 }}</span>
          {{ prompt.title }}
        </h3>
        <div class="prompt-meta">
          <span class="meta-item">üéØ {{ prompt.skill }}</span>
          <span class="meta-item" *ngIf="prompt.questions && prompt.questions.length > 0">
            üìä {{ prompt.questions.length }} c√¢u h·ªèi
          </span>
        </div>
        <p class="prompt-description">{{ prompt.contentText }}</p>
      </div>

      <div class="media-image" *ngIf="prompt.referenceImageUrl && prompt.referenceImageUrl.startsWith('http')">
        <!-- Loading Skeleton -->
        <div class="image-loading" *ngIf="!prompt._imageLoaded">
          <div class="loading-spinner">
            <i class="fas fa-circle-notch fa-spin"></i>
          </div>
          <p class="loading-text">ƒêang t·∫°o ·∫£nh t·ª´ AI...</p>
          <small class="loading-hint">C√≥ th·ªÉ m·∫•t v√†i gi√¢y</small>
        </div>
        
        <!-- Actual Image -->
        <img 
          [src]="prompt.referenceImageUrl" 
          alt="AI Generated Image"
          (load)="onImageLoad(prompt)"
          (error)="onImageError(prompt)"
          [style.display]="prompt._imageLoaded ? 'block' : 'none'"
          class="fade-in" />
        
        <!-- Error State -->
        <div class="image-error" *ngIf="prompt._imageError">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Kh√¥ng th·ªÉ t·∫£i ·∫£nh</p>
          <button class="retry-btn" (click)="retryImageLoad(prompt)">
            <i class="fas fa-redo"></i> Th·ª≠ l·∫°i
          </button>
        </div>
      </div>

      <!-- ‚úÖ Audio Player - N·∫øu l√† URL
      <div class="media-audio" *ngIf="prompt.referenceAudioUrl && prompt.referenceAudioUrl.startsWith('http')">
        <div class="media-label">
          <span class="icon">üîä</span>
          <strong>Audio Reference</strong>
        </div>
        <audio controls class="audio-player">
          <source [src]="prompt.referenceAudioUrl" type="audio/mpeg">
          Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ audio.
        </audio>
      </div> -->

      <!-- ‚úÖ Audio Text Description - N·∫øu l√† text -->
      <div class="media-description" *ngIf="prompt.referenceAudioUrl && !prompt.referenceAudioUrl.startsWith('http')">
        <div class="media-label">
          <span class="icon">üîä</span>
          <strong>N·ªôi dung Audio</strong>
        </div>
        <div class="media-content">{{ prompt.referenceAudioUrl }}</div>
        <div class="media-note">üí° Audio s·∫Ω ƒë∆∞·ª£c t·∫°o khi l∆∞u ƒë·ªÅ thi</div>
      </div>

      <!-- ‚úÖ Questions List -->
      <div class="questions-container" *ngIf="prompt.questions && prompt.questions.length > 0">
        <div class="question-card" *ngFor="let q of prompt.questions; let qIdx = index">
          <!-- Question Header -->
          <div class="question-header">
            <span class="question-number">C√¢u {{ qIdx + 1 }}</span>
            <div class="question-meta">
              <span class="meta-tag" *ngIf="q.question?.time">‚è±Ô∏è {{ q.question.time }}s</span>
              <span class="meta-tag" *ngIf="q.question?.scoreWeight">üíØ {{ q.question.scoreWeight }} ƒëi·ªÉm</span>
            </div>
          </div>

          <!-- Question Text -->
          <div class="question-text" *ngIf="q.question?.stemText">
            {{ q.question.stemText }}
          </div>

          <!-- ‚úÖ Options (Ch·ªâ hi·ªÉn th·ªã n·∫øu t·ªìn t·∫°i v√† c√≥ n·ªôi dung) -->
          <div class="options-grid" *ngIf="q.options && q.options.length > 0">
            <div class="option-item" *ngFor="let opt of q.options; let oIdx = index" [class.correct]="opt.isCorrect">
              <div class="option-header">
                <span class="option-letter">{{ getOptionLabel(oIdx) }}</span>
                <span class="correct-icon" *ngIf="opt.isCorrect">‚úì</span>
              </div>
              <div class="option-content" *ngIf="opt.content">
                {{ opt.content }}
              </div>
            </div>
          </div>

          <!-- ‚úÖ Explanation -->
          <div class="explanation-box" *ngIf="q.question?.questionExplain">
            <div class="explanation-header">
              <span class="icon">üí°</span>
              <strong>Gi·∫£i th√≠ch</strong>
            </div>
            <div class="explanation-content">
              {{ q.question.questionExplain }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>