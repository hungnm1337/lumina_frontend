<div class="articles-container">
  <!-- TOEIC Header Section - STAFF VERSION -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">
          <span class="toeic-badge">TOEIC</span>
          Article Management
        </h1>
        <p class="page-subtitle">
          Create educational content for TOEIC skill development
        </p>
      </div>
      <div class="header-stats">
        <div class="stat-card">
          <div class="stat-number">{{total || 0}}</div>
          <div class="stat-label">Total Articles</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{categories.length}}</div>
          <div class="stat-label">Categories</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{getPublishedCount()}}</div>
          <div class="stat-label">Published</div>
        </div>
      </div>
    </div>
    
    <!-- CREATE BUTTON - STAFF CAN CREATE -->
    <div class="header-actions" *ngIf="isStaff">
      <button class="btn-create-article" (click)="openModal()">
        <i class="fas fa-plus"></i>
        <span class="btn-text">Create Article</span>
      </button>
      <button class="btn-add-category" (click)="openAddCategoryModal()" title="Add New Category" type="button">
        <i class="fas fa-plus"></i>
        <span class="btn-text">Add Category</span>
      </button>
    </div>
  </div>

  <!-- Advanced Search & Filter Panel -->
  <div class="search-filter-panel">
    <div class="search-section">
      <div class="search-input-wrapper">
        <i class="fas fa-search search-icon"></i>
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
          placeholder="Search articles, content, categories..."
          class="search-input">
        <button 
          *ngIf="searchTerm" 
          (click)="searchTerm = ''; onSearchChange()" 
          class="clear-search-btn">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <div class="filters-section">
      <div class="filter-group">
        <label>Category</label>
        <select [(ngModel)]="selectedCategory" (change)="onCategoryChange()" class="filter-select">
          <option value="">All Categories</option>
          <option *ngFor="let category of categories" [value]="category.name">
            {{category.name}}
          </option>
        </select>
      </div>

      <div class="filter-group">
        <label>Status</label>
        <select [(ngModel)]="selectedStatus" (change)="onStatusChange()" class="filter-select">
          <option value="">All Status</option>
          <option value="draft">Draft</option>
          <option value="pending">Pending</option>
          <option value="published">Published</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Sort By</label>
        <select [(ngModel)]="sortBy" (change)="changeSort(sortBy, sortDir)" class="filter-select">
          <option value="createdAt">Date Created</option>
          <option value="title">Title</option>
          <option value="category">Category</option>
        </select>
      </div>

      <div class="filter-actions">
        <button (click)="selectedCategory = ''; selectedStatus = ''; onFilterChange()" class="btn-clear-filters">
          <i class="fas fa-eraser"></i>
          Clear All
        </button>
        <button (click)="loadArticles()" class="btn-refresh">
          <i class="fas fa-sync-alt"></i>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Articles List -->
    <div class="articles-list-section">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-state">
        <div class="loading-spinner">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
        <p>Loading articles...</p>
      </div>

      <!-- Articles Grid -->
      <div *ngIf="!isLoading" class="articles-grid">
        <div 
          *ngFor="let article of filteredArticles; let i = index" 
          class="article-card"
          [class.featured]="article.status === 'published'">
          
          <!-- Card Header -->
          <div class="card-header">
            <div class="article-status-section">
              <span class="status-badge" [ngClass]="getStatusClass(article.status)">
                <i class="fas fa-circle status-dot"></i>
                {{getStatusText(article.status)}}
              </span>
            </div>
            
            <div class="card-actions">
              <div class="action-buttons">
                <!-- STAFF CAN EDIT -->
                <button 
                  *ngIf="isStaff"
                  class="btn-action btn-edit" 
                  (click)="openModal(article)"
                  title="Edit article">
                  <i class="fas fa-edit"></i>
                </button>
                
                <!-- STAFF CAN SUBMIT FOR APPROVAL -->
                <button 
                  *ngIf="article.status === 'draft' && isStaff" 
                  class="btn-action btn-submit" 
                  [class.btn-resubmit]="article.rejectionReason"
                  (click)="submitForApproval(article.id)"
                  [title]="article.rejectionReason ? 'Gửi lại để duyệt' : 'Submit for approval'">
                  <i class="fas fa-paper-plane"></i>
                  <span *ngIf="article.rejectionReason" class="resubmit-badge">Gửi lại</span>
                </button>
                
                <!-- ONLY MANAGER CAN APPROVE/REJECT -->
                <ng-container *ngIf="canApproveReject()">
                  <button 
                    *ngIf="article.status === 'pending'" 
                    class="btn-action btn-approve" 
                    (click)="approveArticle(article.id)"
                    title="Approve & publish">
                    <i class="fas fa-check"></i>
                  </button>
                  <button 
                    *ngIf="article.status === 'pending'" 
                    class="btn-action btn-reject" 
                    (click)="rejectArticle(article.id)"
                    title="Reject article">
                    <i class="fas fa-times"></i>
                  </button>
                </ng-container>
                
                <!-- STAFF CAN DELETE -->
                <button 
                  *ngIf="isStaff"
                  class="btn-action btn-delete" 
                  (click)="deleteArticle(article.id)"
                  title="Delete article">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Card Content -->
          <div class="card-content">
            <!-- Title & Category -->
            <div class="article-meta-top">
              <h3 class="article-title">{{article.title}}</h3>
              <span class="category-tag">
                <i class="fas fa-tag"></i>
                {{article.category}}
              </span>
            </div>

            <!-- Summary -->
            <div class="article-summary">
              <p class="summary-text">{{article.summary}}</p>
            </div>

            <!-- Rejection Reason Alert -->
            <div *ngIf="article.rejectionReason" class="rejection-alert">
              <div class="alert-header">
                <i class="fas fa-exclamation-triangle"></i>
                <span class="alert-title">Bài viết đã bị từ chối</span>
              </div>
              <div class="alert-content">
                <p class="rejection-reason">{{ article.rejectionReason }}</p>
                <p class="rejection-hint">
                  <i class="fas fa-info-circle"></i>
                  Vui lòng sửa lại bài viết theo góp ý và gửi lại để duyệt.
                </p>
              </div>
            </div>

            <!-- Article Info -->
            <div class="article-info-section">
              <div class="info-item">
                <i class="fas fa-file-alt"></i>
                <span>{{getSectionCount(article)}} sections</span>
              </div>
              <div class="info-item">
                <i class="fas fa-calendar-alt"></i>
                <span>{{getArticleDate(article) | date:'MMM dd, yyyy'}}</span>
              </div>
              <div class="info-item">
                <i class="fas fa-user"></i>
                <span>{{getAuthorName(article)}}</span>
              </div>
            </div>

            <!-- Tags -->
            <div class="tags-section" *ngIf="article.tags && article.tags.length > 0">
              <div class="tags-container">
                <span *ngFor="let tag of article.tags" class="tag-item">
                  {{tag}}
                </span>
              </div>
            </div>

            <!-- TOEIC Skills Indicator -->
            <div class="toeic-skills-footer">
              <span class="toeic-indicator">
                <i class="fas fa-star"></i>
                TOEIC Learning Content
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isLoading && filteredArticles.length === 0" class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <h3>No articles found</h3>
        <p>Try changing your filters or create your first article</p>
        <button class="btn-add-first" (click)="openModal()" *ngIf="isStaff">
          <i class="fas fa-plus"></i>
          Create Your First Article
        </button>
      </div>

      <!-- Pagination -->
      <div *ngIf="!isLoading && total > pageSize" class="pagination-section">
        <div class="pagination-info">
          Page {{page}} / {{Math.ceil(total / pageSize)}} · Total {{total | number}} articles
        </div>
        <div class="pagination-controls">
          <button 
            class="btn-page" 
            [disabled]="page <= 1" 
            (click)="prevPage()">
            <i class="fas fa-chevron-left"></i>
            Previous
          </button>
          <span class="current-page">{{page}}</span>
          <button 
            class="btn-page" 
            [disabled]="page * pageSize >= total" 
            (click)="nextPage()">
            Next
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Sidebar with Statistics - STAFF VERSION -->
    <div class="articles-sidebar">
      <!-- TOEIC Staff Content Card -->
      <div class="toeic-content-card">
        <div class="card-header">
          <div class="toeic-logo">
            <i class="fas fa-user-edit"></i>
          </div>
          <div class="content-title">
            <h3>Staff Dashboard</h3>
            <p>Content creation & management</p>
          </div>
        </div>
        <div class="content-stats">
          <div class="stat-item">
            <div class="stat-icon published">
              <i class="fas fa-globe"></i>
            </div>
            <div class="stat-details">
              <span class="stat-value">{{getPublishedCount()}}</span>
              <span class="stat-label">Published</span>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-icon pending">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-details">
              <span class="stat-value">{{getPendingCount()}}</span>
              <span class="stat-label">Pending</span>
            </div>
          </div>
          <div class="stat-item">
            <div class="stat-icon draft">
              <i class="fas fa-edit"></i>
            </div>
            <div class="stat-details">
              <span class="stat-value">{{getDraftCount()}}</span>
              <span class="stat-label">My Drafts</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Category Distribution -->
      <div class="stats-card">
        <div class="card-header">
          <i class="fas fa-chart-pie"></i>
          <h3>Category Distribution</h3>
        </div>
        <div class="category-stats">
          <div *ngFor="let category of categories" class="category-stat-item">
            <div class="category-info">
              <span class="category-icon">📚</span>
              <span class="category-name">{{category.name}}</span>
            </div>
            <div class="category-count">
              <span class="count">{{getCategoryCount(category.name)}}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Staff Quick Actions -->
      <div class="quick-actions-card" *ngIf="isStaff">
        <div class="card-header">
          <i class="fas fa-lightning-bolt"></i>
          <h3>Staff Actions</h3>
        </div>
        <div class="action-buttons-grid">
          <!-- MAIN CREATE BUTTON -->
          <button class="quick-action-btn create-main" (click)="openModal()">
            <i class="fas fa-plus-circle"></i>
            <span>Create Article</span>
          </button>
          
          <button class="quick-action-btn drafts" (click)="showMyDrafts()">
            <i class="fas fa-edit"></i>
            <span>My Drafts</span>
          </button>
          <button class="quick-action-btn pending" (click)="showPendingReview()">
            <i class="fas fa-clock"></i>
            <span>Pending Review</span>
          </button>
          <button class="quick-action-btn published" (click)="showPublished()">
            <i class="fas fa-globe"></i>
            <span>Published</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Modal Form - STAFF VERSION -->
<div *ngIf="isModalOpen" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-header-content">
        <div class="modal-icon">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="modal-title-section">
          <h2>
            {{editingArticle ? 'Edit Article' : 'Create New Article'}}
          </h2>
          <p>Build engaging TOEIC learning content</p>
        </div>
      </div>
      <button class="btn-close" (click)="closeModal()" type="button">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <form [formGroup]="articleForm" (ngSubmit)="saveArticle()" class="modal-form">
      <!-- Basic Information -->
      <div class="form-group">
        <label for="category">Category</label>
        <select id="category" formControlName="category" class="form-select" required>
          <option value="">Select category...</option>
          <option *ngFor="let category of categoryNames" [value]="category">
            {{category}}
          </option>
        </select>
        <div *ngIf="articleForm.get('category')?.invalid && articleForm.get('category')?.touched" 
             class="error-message">
          Category is required
        </div>
      </div>

      <div class="form-group">
        <label for="title">Article Title</label>
        <input
          id="title"
          type="text"
          formControlName="title"
          placeholder="Enter engaging article title..."
          class="form-input"
          required>
        <div *ngIf="articleForm.get('title')?.invalid && articleForm.get('title')?.touched" 
             class="error-message">
          Title must be at least 5 characters
        </div>
      </div>

      <div class="form-group">
        <label for="summary">Summary</label>
        <textarea
          id="summary"
          formControlName="summary"
          rows="3"
          placeholder="Brief description of the article content..."
          class="form-textarea"
          required></textarea>
        <div *ngIf="articleForm.get('summary')?.invalid && articleForm.get('summary')?.touched" 
             class="error-message">
          Summary must be at least 20 characters
        </div>
      </div>

      <!-- Content Sections - FULL FUNCTIONALITY -->
      <div class="sections-container">
        <div class="sections-header">
          <h3>Article Sections</h3>
          <p>Create structured content with multiple sections</p>
        </div>

        <!-- Dynamic Sections -->
        <div formArrayName="sections">
          <div *ngFor="let sectionGroup of sections.controls; let i = index" 
               class="section-item" 
               [formGroupName]="i">
            
            <!-- Section Header -->
            <div class="section-header">
              <div class="section-number">{{i + 1}}</div>
              
              <div class="section-form-group">
                <label>Section Title</label>
                <input
                  type="text"
                  formControlName="sectionTitle"
                  placeholder="Enter section title..."
                  class="form-input">
                <div *ngIf="sectionGroup.get('sectionTitle')?.invalid && sectionGroup.get('sectionTitle')?.touched" 
                     class="error-message">
                  Section title is required
                </div>
              </div>
              
              <div class="section-type-group">
                <label>Type</label>
                <select formControlName="type" class="form-select">
                  <option *ngFor="let type of sectionTypes" [value]="type.value">
                    {{type.label}}
                  </option>
                </select>
              </div>
            </div>

            <!-- Section Content -->
<div class="section-content">
  <label>Content</label>
  
  <!-- QUILL-EDITOR với Cloudinary upload -->
  <quill-editor 
    formControlName="content"
    [placeholder]="sectionGroup.get('type')?.value === 'video' ? 'Paste YouTube video URL here (e.g., https://www.youtube.com/watch?v=...)' : 'Enter section content...'"
    [modules]="getQuillConfig(i)"
    [styles]="{ 'min-height': '150px' }"
    (onEditorCreated)="onEditorCreated($event, i)"> 
  </quill-editor>

  <!-- Upload progress indicator -->
  <div *ngIf="uploadingImages[i]" class="upload-progress">
    <i class="fas fa-spinner fa-spin"></i>
    <span>Đang upload lên Cloudinary...</span>
  </div>

  <div *ngIf="sectionGroup.get('content')?.invalid && sectionGroup.get('content')?.touched" 
       class="error-message">
    <span *ngIf="sectionGroup.get('type')?.value === 'video'">
      Please paste a YouTube video URL
    </span>
    <span *ngIf="sectionGroup.get('type')?.value !== 'video'">
      Content is required
    </span>
  </div>
</div>

            <!-- Section Controls -->
            <div class="section-controls">
              <button
                type="button"
                class="btn-control btn-up"
                (click)="moveSectionUp(i)"
                [disabled]="i === 0">
                <i class="fas fa-arrow-up"></i>
                Up
              </button>
              <button
                type="button"
                class="btn-control btn-down"
                (click)="moveSectionDown(i)"
                [disabled]="i === sections.length - 1">
                <i class="fas fa-arrow-down"></i>
                Down
              </button>
              <button
                type="button"
                class="btn-control btn-remove"
                (click)="removeSection(i)"
                [disabled]="sections.length === 1">
                <i class="fas fa-trash"></i>
                Remove
              </button>
            </div>
          </div>
        </div>

        <!-- Add Section Button -->
        <button
          type="button"
          class="btn-add-section"
          (click)="addSection()">
          <i class="fas fa-plus"></i>
          Add Section
        </button>
      </div>

      <!-- Tags -->
      <div class="form-group">
        <label for="tags">Tags</label>
        <input
          id="tags"
          type="text"
          formControlName="tags"
          placeholder="Enter tags separated by commas..."
          class="form-input">
        <small class="form-hint">Separate multiple tags with commas</small>
      </div>

      <!-- Modal Actions -->
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeModal()">
          Cancel
        </button>
        <button 
          type="submit" 
          class="btn-primary" 
          [disabled]="articleForm.invalid || isSubmitting">
          <i *ngIf="isSubmitting" class="fas fa-spinner fa-spin"></i>
          <i *ngIf="!isSubmitting && !editingArticle" class="fas fa-plus"></i>
          <i *ngIf="!isSubmitting && editingArticle" class="fas fa-save"></i>
          {{editingArticle ? 'Update Article' : 'Create Article'}}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Add Category Modal -->
<div *ngIf="isAddCategoryModalOpen" class="modal-overlay" (click)="closeAddCategoryModal()">
  <div class="modal-content modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-header-content">
        <div class="modal-icon">
          <i class="fas fa-folder-plus"></i>
        </div>
        <div class="modal-title-section">
          <h2>Add New Category</h2>
          <p>Create a new category for articles</p>
        </div>
      </div>
      <button class="btn-close" (click)="closeAddCategoryModal()" type="button">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <form [formGroup]="categoryForm" (ngSubmit)="onSubmitCategory()" class="modal-form">
      <div class="form-group">
        <label for="categoryName">
          <i class="fas fa-tag"></i>
          Category Name
        </label>
        <input
          id="categoryName"
          type="text"
          formControlName="name"
          placeholder="Enter category name (e.g., Business, Entertainment, Food...)"
          class="form-input"
          [class.error]="categoryForm.get('name')?.invalid && categoryForm.get('name')?.touched"
          required>
        <div *ngIf="categoryForm.get('name')?.invalid && categoryForm.get('name')?.touched" 
             class="error-message">
          <i class="fas fa-exclamation-circle"></i>
          <span *ngIf="categoryForm.get('name')?.errors?.['required']">Category name is required</span>
          <span *ngIf="categoryForm.get('name')?.errors?.['minlength']">Category name must be at least 2 characters</span>
          <span *ngIf="categoryForm.get('name')?.errors?.['maxlength']">Category name must not exceed 50 characters</span>
        </div>
        <small class="form-hint">
          <i class="fas fa-info-circle"></i>
          Enter a unique name for the new category. This will be used to organize articles.
        </small>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeAddCategoryModal()">
          <i class="fas fa-times"></i>
          Cancel
        </button>
        <button 
          type="submit" 
          class="btn-primary" 
          [disabled]="categoryForm.invalid || isSubmittingCategory">
          <i *ngIf="isSubmittingCategory" class="fas fa-spinner fa-spin"></i>
          <i *ngIf="!isSubmittingCategory" class="fas fa-plus"></i>
          Create Category
        </button>
      </div>
    </form>
  </div>
</div>
